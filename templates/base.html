<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CommerceBox{% endblock %}</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% block navbar %}
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-box-seam"></i> CommerceBox
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto" id="navbarMenu">
                    <!-- Se llenarán con JavaScript cuando esté autenticado -->
                </ul>
                
                <div class="d-flex ms-3" id="userSection">
                    <!-- Usuario autenticado -->
                </div>
            </div>
        </div>
    </nav>
    {% endblock %}

    {% block alert_container %}
    <!-- Alertas -->
    <div class="container mt-3">
        <div id="alertContainer"></div>
    </div>
    {% endblock %}

    <!-- Contenido principal -->
    {% block main_wrapper %}
    <main class="container mt-4">
        {% block content %}{% endblock %}
    </main>
    {% endblock %}

    {% block footer %}
    <!-- Footer -->
    <footer class="bg-dark text-white text-center py-3 mt-5">
        <p class="mb-0">&copy; 2025 CommerceBox - Sistema de Gestión Comercial</p>
    </footer>
    {% endblock %}

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- API Configuration -->
    <script>
        const API_BASE_URL = 'http://localhost:8000/api';
        
        // Funciones de autenticación
        const auth = {
            // Obtener token del localStorage
            getToken() {
                return localStorage.getItem('access_token');
            },
            
            // Obtener refresh token
            getRefreshToken() {
                return localStorage.getItem('refresh_token');
            },
            
            // Guardar tokens
            setTokens(access, refresh) {
                localStorage.setItem('access_token', access);
                localStorage.setItem('refresh_token', refresh);
            },
            
            // Eliminar tokens
            clearTokens() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user_data');
            },
            
            // Verificar si está autenticado
            isAuthenticated() {
                return !!this.getToken();
            },
            
            // Hacer petición con token
            async fetch(url, options = {}) {
                const token = this.getToken();
                
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(`${API_BASE_URL}${url}`, {
                    ...options,
                    headers
                });
                
                // Si el token expiró, intentar refrescar
                if (response.status === 401 && this.getRefreshToken()) {
                    const refreshed = await this.refreshToken();
                    if (refreshed) {
                        // Reintentar la petición original
                        headers['Authorization'] = `Bearer ${this.getToken()}`;
                        return fetch(`${API_BASE_URL}${url}`, {
                            ...options,
                            headers
                        });
                    }
                }
                
                return response;
            },
            
            // Refrescar token
            async refreshToken() {
                try {
                    const response = await fetch(`${API_BASE_URL}/auth/login/refresh/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ refresh: this.getRefreshToken() })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.setTokens(data.access, data.refresh);
                        return true;
                    }
                    
                    this.clearTokens();
                    window.location.href = '/login/';
                    return false;
                } catch (error) {
                    console.error('Error al refrescar token:', error);
                    return false;
                }
            },
            
            // Login
            async login(username, password) {
                try {
                    const response = await fetch(`${API_BASE_URL}/auth/login/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.setTokens(data.access, data.refresh);
                        
                        // Obtener datos del usuario
                        await this.getUserData();
                        
                        return { success: true };
                    }
                    
                    const error = await response.json();
                    return { success: false, error: error.detail || 'Credenciales inválidas' };
                } catch (error) {
                    return { success: false, error: 'Error de conexión' };
                }
            },
            
            // Logout
            async logout() {
                try {
                    const refresh = this.getRefreshToken();
                    if (refresh) {
                        await fetch(`${API_BASE_URL}/auth/logout/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.getToken()}`
                            },
                            body: JSON.stringify({ refresh })
                        });
                    }
                } catch (error) {
                    console.error('Error al hacer logout:', error);
                } finally {
                    this.clearTokens();
                    window.location.href = '/login/';
                }
            },
            
            // Obtener datos del usuario
            async getUserData() {
                try {
                    const response = await this.fetch('/auth/perfil/');
                    if (response.ok) {
                        const userData = await response.json();
                        localStorage.setItem('user_data', JSON.stringify(userData));
                        return userData;
                    }
                } catch (error) {
                    console.error('Error al obtener datos del usuario:', error);
                }
                return null;
            },
            
            // Obtener usuario del localStorage
            getUser() {
                const userData = localStorage.getItem('user_data');
                return userData ? JSON.parse(userData) : null;
            }
        };
        
        // Mostrar alerta
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return; // Si no existe el contenedor, no hacer nada
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Inicializar interfaz según autenticación
        document.addEventListener('DOMContentLoaded', () => {
            const user = auth.getUser();
            const userSection = document.getElementById('userSection');
            const navbarMenu = document.getElementById('navbarMenu');
            
            if (user && userSection && navbarMenu) {
                // Mostrar menú autenticado
                navbarMenu.innerHTML = `
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard/">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/inventario/">
                            <i class="bi bi-box"></i> Inventario
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/ventas/">
                            <i class="bi bi-cart"></i> Ventas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reportes/">
                            <i class="bi bi-graph-up"></i> Reportes
                        </a>
                    </li>
                `;
                
                userSection.innerHTML = `
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> ${user.nombres || user.username}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/perfil/">Mi Perfil</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="auth.logout()">Cerrar Sesión</a></li>
                        </ul>
                    </div>
                `;
            } else {
                // No autenticado
                if (!window.location.pathname.includes('login')) {
                    window.location.href = '/login/';
                }
            }
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>