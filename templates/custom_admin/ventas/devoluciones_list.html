{% extends "custom_admin/base_admin.html" %}
{% load static %}

{% block title %}Devoluciones{% endblock %}

{% block extra_css %}
<style>
    /* ============================================
       ESTILOS MEJORADOS PARA DEVOLUCIONES
       ============================================ */
    
    /* Modal mejorado */
    .modal-content {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(219, 234, 254, 0.5);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(96, 165, 250, 0.05) 100%);
        border-bottom: 2px solid rgba(59, 130, 246, 0.15);
        border-radius: 20px 20px 0 0;
        padding: 1.5rem;
    }
    
    .modal-title {
        color: #0f172a;
        font-weight: 700;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .modal-title i {
        font-size: 1.75rem;
        color: #3b82f6;
    }
    
    .modal-body {
        padding: 2rem;
    }
    
    /* Input group mejorado */
    .search-input-group {
        position: relative;
        margin-bottom: 1.5rem;
    }
    
    .search-input-group label {
        color: #1e293b;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .search-input-wrapper {
        display: flex;
        gap: 0.75rem;
    }
    
    .search-input-wrapper input {
        flex: 1;
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid rgba(203, 213, 225, 0.5);
        border-radius: 12px;
        padding: 0.875rem 1rem;
        color: #1e293b;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .search-input-wrapper input:focus {
        background: rgba(255, 255, 255, 1);
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        outline: none;
    }
    
    .search-btn {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border: none;
        padding: 0.875rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }
    
    .search-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    }
    
    /* Card de informaci√≥n de venta */
    .venta-info-card {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(96, 165, 250, 0.05) 100%);
        border: 2px solid rgba(59, 130, 246, 0.2);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        display: none;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .venta-info-card h6 {
        color: #0f172a;
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .venta-info-card h6 i {
        color: #3b82f6;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }
    
    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .info-label {
        font-weight: 600;
        color: #64748b;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .info-value {
        font-weight: 700;
        color: #0f172a;
        font-size: 1rem;
    }
    
    .info-value.highlight {
        color: #3b82f6;
        font-size: 1.25rem;
    }
    
    /* Form controls mejorados */
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        color: #1e293b;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .form-control,
    .form-select {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid rgba(203, 213, 225, 0.5);
        border-radius: 12px;
        padding: 0.875rem 1rem;
        color: #1e293b;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .form-control:focus,
    .form-select:focus {
        background: rgba(255, 255, 255, 1);
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        outline: none;
    }
    
    textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }
    
    .quantity-helper {
        color: #64748b;
        font-size: 0.85rem;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .quantity-helper i {
        color: #3b82f6;
    }
    
    /* Bot√≥n de procesar */
    .btn-procesar {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
        width: 100%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        cursor: pointer;
    }
    
    .btn-procesar:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 24px rgba(34, 197, 94, 0.4);
        background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
    }
    
    .btn-procesar i {
        font-size: 1.25rem;
    }
    
    /* Tabla mejorada */
    .table-wrapper {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(30px) saturate(180%);
        border: 1px solid rgba(219, 234, 254, 0.5);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 
            0 4px 12px rgba(59, 130, 246, 0.08),
            0 2px 4px rgba(0, 0, 0, 0.02);
    }
    
    .table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table thead {
        background: rgba(59, 130, 246, 0.08);
        border-radius: 12px 12px 0 0;
    }
    
    .table thead th {
        padding: 1rem;
        color: #1e293b;
        font-weight: 700;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        border-bottom: 2px solid rgba(59, 130, 246, 0.15);
        white-space: nowrap;
    }
    
    .table thead th:first-child {
        border-radius: 12px 0 0 0;
    }
    
    .table thead th:last-child {
        border-radius: 0 12px 0 0;
    }
    
    .table tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid rgba(219, 234, 254, 0.3);
        background: rgba(255, 255, 255, 0.5);
    }
    
    .table tbody tr:hover {
        background: rgba(59, 130, 246, 0.05);
        transform: translateX(2px);
    }
    
    .table tbody td {
        padding: 1rem;
        color: #1e293b;
        font-size: 0.9rem;
        vertical-align: middle;
    }
    
    /* Badges mejorados */
    .badge {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .badge-pendiente {
        background: rgba(251, 191, 36, 0.15);
        color: #b45309;
        border: 1px solid rgba(251, 191, 36, 0.3);
    }
    
    .badge-aprobada {
        background: rgba(34, 197, 94, 0.15);
        color: #15803d;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .badge-rechazada {
        background: rgba(239, 68, 68, 0.15);
        color: #b91c1c;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    /* Botones de acci√≥n */
    .btn-action {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-info {
        background: rgba(59, 130, 246, 0.1);
        color: #1e40af;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }
    
    .btn-info:hover {
        background: rgba(59, 130, 246, 0.2);
        transform: translateY(-1px);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }
    
    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
    }
    
    .empty-state i {
        font-size: 4rem;
        color: #cbd5e1;
        margin-bottom: 1rem;
    }
    
    .empty-state p {
        color: #64748b;
        font-size: 1.1rem;
    }
    
    /* Page header */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .page-title {
        font-size: 2rem;
        font-weight: 800;
        color: #0f172a;
        letter-spacing: -0.5px;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .page-title i {
        color: #3b82f6;
    }
    
    .btn-nueva-devolucion {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border: none;
        padding: 0.875rem 1.75rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
    }
    
    .btn-nueva-devolucion:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .search-input-wrapper {
            flex-direction: column;
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
            width: 100%;
        }
        
        .btn-action {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-arrow-return-left"></i>
            Gesti√≥n de Devoluciones
        </h1>
        <button class="btn-nueva-devolucion" data-bs-toggle="modal" data-bs-target="#modalNuevaDevolucion">
            <i class="bi bi-plus-circle"></i>
            Nueva Devoluci√≥n
        </button>
    </div>

    <!-- Tabla de Devoluciones -->
    <div class="table-wrapper">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>N√∫mero</th>
                        <th>Venta Original</th>
                        <th>Cliente</th>
                        <th>Fecha</th>
                        <th>Monto</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
    {% for devolucion in devoluciones %}
    <tr>
        <td><strong>{{ devolucion.numero_devolucion }}</strong></td>
        <td>{{ devolucion.venta_original.numero_venta }}</td>
        <td>{{ devolucion.venta_original.cliente.nombre_completo|default:"Cliente General" }}</td>
        <td>{{ devolucion.fecha_devolucion|date:"d/m/Y H:i" }}</td>
        <td><strong>${{ devolucion.monto_devolucion|floatformat:2 }}</strong></td>
        <td>
            {% if devolucion.estado == 'PENDIENTE' %}
            <span class="badge badge-pendiente">
                <i class="bi bi-clock-fill"></i> PENDIENTE
            </span>
            {% elif devolucion.estado == 'APROBADA' %}
            <span class="badge badge-aprobada">
                <i class="bi bi-check-circle-fill"></i> APROBADA
            </span>
            {% else %}
            <span class="badge badge-rechazada">
                <i class="bi bi-x-circle-fill"></i> RECHAZADA
            </span>
            {% endif %}
        </td>
        <td>
            <div class="action-buttons">
                <button class="btn-action btn-info" onclick="verDetalle('{{ devolucion.id }}')">
                    <i class="bi bi-eye"></i> Ver
                </button>
                {% if devolucion.estado == 'PENDIENTE' %}
                <button class="btn-action btn-success" onclick="aprobarDevolucion('{{ devolucion.id }}', '{{ devolucion.numero_devolucion }}')">
                    <i class="bi bi-check-circle"></i> Aprobar
                </button>
                <button class="btn-action btn-danger" onclick="rechazarDevolucion('{{ devolucion.id }}', '{{ devolucion.numero_devolucion }}')">
                    <i class="bi bi-x-circle"></i> Rechazar
                </button>
                {% endif %}
            </div>
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="7">
            <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <p>No hay devoluciones registradas</p>
            </div>
        </td>
    </tr>
    {% endfor %}
</tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Nueva Devoluci√≥n -->
<div class="modal fade" id="modalNuevaDevolucion" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-return-left"></i>
                    Nueva Devoluci√≥n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formDevolucion">
                    {% csrf_token %}
                    
                    <!-- B√∫squeda de Venta -->
                    <div class="search-input-group">
                        <label>N√∫mero de Venta</label>
                        <div class="search-input-wrapper">
                            <input type="text" id="numeroVenta" placeholder="Ej: VNT-2025-00112">
                            <button type="button" class="search-btn" onclick="buscarVenta()">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                        </div>
                    </div>

                    <!-- Info de la Venta -->
                    <div id="infoVenta" class="venta-info-card">
                        <h6>
                            <i class="bi bi-receipt"></i>
                            Informaci√≥n de la Venta
                        </h6>
                        <div id="ventaDetalles" class="info-grid"></div>
                    </div>

                    <!-- Selecci√≥n de Producto -->
                    <div id="productosSection" style="display: none;" class="form-group">
                        <label>Producto a Devolver</label>
                        <select class="form-select" id="productoSelect" onchange="seleccionarProducto()">
                            <option value="">Seleccione un producto</option>
                        </select>
                    </div>

                    <!-- Cantidad a Devolver -->
                    <div id="cantidadSection" style="display: none;" class="form-group">
                        <label>Cantidad a Devolver</label>
                        <input type="number" class="form-control" id="cantidadDevolver" min="1" step="0.001">
                        <div class="quantity-helper">
                            <i class="bi bi-info-circle"></i>
                            Cantidad disponible: <strong id="cantidadDisponible">0</strong>
                        </div>
                    </div>

                    <!-- Motivo -->
                    <div class="form-group">
                        <label>Motivo de Devoluci√≥n</label>
                        <select class="form-select" name="motivo" required>
                            <option value="">Seleccione un motivo</option>
                            <option value="DEFECTUOSO">Producto Defectuoso</option>
                            <option value="EQUIVOCACION">Equivocaci√≥n en la Compra</option>
                            <option value="NO_SATISFECHO">No Satisface Expectativas</option>
                            <option value="VENCIDO">Producto Vencido</option>
                            <option value="OTRO">Otro</option>
                        </select>
                    </div>

                    <!-- Observaciones -->
                    <div class="form-group">
                        <label>Descripci√≥n / Observaciones</label>
                        <textarea class="form-control" name="observaciones" placeholder="Describa el motivo de la devoluci√≥n..."></textarea>
                    </div>

                    <button type="submit" class="btn-procesar">
                        <i class="bi bi-check-circle"></i>
                        Procesar Devoluci√≥n
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalle -->
<div class="modal fade" id="modalDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-text"></i>
                    Detalle de Devoluci√≥n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detalleContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Aprobar -->
<div class="modal fade" id="modalAprobar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle"></i>
                    Aprobar Devoluci√≥n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¬øEst√° seguro que desea aprobar la devoluci√≥n <strong id="numeroAprobar"></strong>?</p>
                <p style="color: #64748b; font-size: 0.9rem;">Esta acci√≥n reintegrar√° los productos al inventario y procesar√° el reembolso.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-action btn-danger" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn-action btn-success" onclick="confirmarAprobar()">
                    <i class="bi bi-check-circle"></i> S√≠, Aprobar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Rechazar -->
<div class="modal fade" id="modalRechazar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-x-circle"></i>
                    Rechazar Devoluci√≥n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¬øEst√° seguro que desea rechazar la devoluci√≥n <strong id="numeroRechazar"></strong>?</p>
                <div class="form-group">
                    <label>Motivo del Rechazo</label>
                    <textarea class="form-control" id="motivoRechazo" placeholder="Explique el motivo del rechazo..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-action btn-info" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn-action btn-danger" onclick="confirmarRechazar()">
                    <i class="bi bi-x-circle"></i> S√≠, Rechazar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let devolucionIdActual = null;
let ventaActual = null;
let productoSeleccionado = null;

// Buscar venta y mostrar sus productos
async function buscarVenta() {
    const numeroVenta = document.getElementById('numeroVenta').value.trim();
    
    if (!numeroVenta) {
        alert('Por favor ingrese un n√∫mero de venta');
        return;
    }
    
    try {
        const response = await fetch(`/panel/ventas/api/buscar-venta/?numero=${numeroVenta}`);
        const data = await response.json();
        
        if (data.success) {
            ventaActual = data.venta;
            mostrarInfoVenta(data.venta);
            mostrarProductos(data.venta.productos);
        } else {
            alert('Venta no encontrada');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al buscar la venta');
    }
}

// Mostrar informaci√≥n de la venta
function mostrarInfoVenta(venta) {
    const ventaDetalles = document.getElementById('ventaDetalles');
    ventaDetalles.innerHTML = `
        <div class="info-item">
            <span class="info-label">Cliente</span>
            <span class="info-value">${venta.cliente}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Fecha</span>
            <span class="info-value">${venta.fecha}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Total</span>
            <span class="info-value highlight">$${venta.total}</span>
        </div>
    `;
    document.getElementById('infoVenta').style.display = 'block';
}

// Mostrar productos disponibles
function mostrarProductos(productos) {
    const select = document.getElementById('productoSelect');
    select.innerHTML = '<option value="">Seleccione un producto</option>';
    
    productos.forEach(producto => {
        const option = document.createElement('option');
        option.value = JSON.stringify(producto);
        option.textContent = `${producto.nombre} - Cant: ${producto.cantidad} - $${producto.precio}`;
        select.appendChild(option);
    });
    
    document.getElementById('productosSection').style.display = 'block';
}

// Seleccionar producto
function seleccionarProducto() {
    const select = document.getElementById('productoSelect');
    if (select.value) {
        productoSeleccionado = JSON.parse(select.value);
        document.getElementById('cantidadDisponible').textContent = productoSeleccionado.cantidad;
        document.getElementById('cantidadDevolver').max = productoSeleccionado.cantidad;
        document.getElementById('cantidadDevolver').value = 1;
        document.getElementById('cantidadSection').style.display = 'block';
    } else {
        document.getElementById('cantidadSection').style.display = 'none';
    }
}

// Procesar devoluci√≥n
document.getElementById('formDevolucion').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!ventaActual || !productoSeleccionado) {
        alert('Por favor busque una venta y seleccione un producto');
        return;
    }
    
    const cantidadDevolver = parseFloat(document.getElementById('cantidadDevolver').value);
    
    if (!cantidadDevolver || cantidadDevolver < 0.001 || cantidadDevolver > productoSeleccionado.cantidad) {
        alert('Cantidad inv√°lida');
        return;
    }
    
    const formData = {
        venta_id: ventaActual.id,
        detalle_venta_id: productoSeleccionado.id,
        cantidad_devuelta: cantidadDevolver,
        motivo: document.querySelector('[name="motivo"]').value,
        descripcion: document.querySelector('[name="observaciones"]').value
    };
    
    try {
        const response = await fetch('/panel/ventas/api/procesar-devolucion/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Devoluci√≥n ${data.numero_devolucion} registrada exitosamente`);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Error desconocido'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al procesar la devoluci√≥n');
    }
});

// Ver detalle de devoluci√≥n
async function verDetalle(id) {
    try {
        const response = await fetch(`/panel/api/devoluciones/${id}/`);
        const data = await response.json();
        
        if (data.success) {
            const dev = data.devolucion;
            
            // Iconos seg√∫n motivo
            let motivoIcon = '‚ùì';
            if (dev.motivo === 'DEFECTUOSO') motivoIcon = 'üîß';
            else if (dev.motivo === 'EQUIVOCACION') motivoIcon = '‚ùå';
            else if (dev.motivo === 'NO_SATISFECHO') motivoIcon = 'üòû';
            else if (dev.motivo === 'VENCIDO') motivoIcon = '‚è∞';
            else if (dev.motivo === 'OTRO') motivoIcon = 'üìù';
            
            // Badge seg√∫n estado
            let estadoBadge = '';
            if (dev.estado === 'PENDIENTE') {
                estadoBadge = '<span class="badge badge-pendiente"><i class="bi bi-clock-fill"></i> PENDIENTE</span>';
            } else if (dev.estado === 'APROBADA') {
                estadoBadge = '<span class="badge badge-aprobada"><i class="bi bi-check-circle-fill"></i> APROBADA</span>';
            } else {
                estadoBadge = '<span class="badge badge-rechazada"><i class="bi bi-x-circle-fill"></i> RECHAZADA</span>';
            }
            
            document.getElementById('detalleContent').innerHTML = `
                <div class="venta-info-card" style="display: block;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                        <div class="info-item">
                            <span class="info-label">N√∫mero Devoluci√≥n</span>
                            <span class="info-value">${dev.numero_devolucion}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Estado</span>
                            <span class="info-value">${estadoBadge}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Venta Original</span>
                            <span class="info-value">${dev.venta_original}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Cliente</span>
                            <span class="info-value">${dev.cliente}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Producto</span>
                            <span class="info-value">${dev.producto}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Cantidad Devuelta</span>
                            <span class="info-value">${dev.cantidad_devuelta}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Monto</span>
                            <span class="info-value highlight">$${dev.monto}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Motivo</span>
                            <span class="info-value">${motivoIcon} ${dev.motivo_display}</span>
                        </div>
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <span class="info-label">Descripci√≥n</span>
                            <span class="info-value">${dev.descripcion}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Usuario Solicita</span>
                            <span class="info-value">${dev.usuario_solicita}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Fecha Solicitud</span>
                            <span class="info-value">${dev.fecha_devolucion}</span>
                        </div>
                        ${dev.usuario_aprueba ? `
                        <div class="info-item">
                            <span class="info-label">Usuario Aprueba</span>
                            <span class="info-value">${dev.usuario_aprueba}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Fecha Procesado</span>
                            <span class="info-value">${dev.fecha_procesado}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
            modal.show();
        } else {
            alert('Error al cargar el detalle: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar el detalle');
    }
}

// Aprobar devoluci√≥n
function aprobarDevolucion(id, numero) {
    devolucionIdActual = id;
    document.getElementById('numeroAprobar').textContent = numero;
    const modal = new bootstrap.Modal(document.getElementById('modalAprobar'));
    modal.show();
}

async function confirmarAprobar() {
    try {
        const response = await fetch(`/panel/ventas/api/aprobar-devolucion/${devolucionIdActual}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ decision: 'APROBADA' })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Devoluci√≥n aprobada exitosamente');
            location.reload();
        } else {
            alert('Error al aprobar: ' + (data.error || 'Error desconocido'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al aprobar la devoluci√≥n');
    }
}

// Rechazar devoluci√≥n
function rechazarDevolucion(id, numero) {
    devolucionIdActual = id;
    document.getElementById('numeroRechazar').textContent = numero;
    document.getElementById('motivoRechazo').value = '';
    const modal = new bootstrap.Modal(document.getElementById('modalRechazar'));
    modal.show();
}

async function confirmarRechazar() {
    const observaciones = document.getElementById('motivoRechazo').value.trim();
    
    if (!observaciones) {
        alert('Por favor ingrese el motivo del rechazo');
        return;
    }
    
    try {
        const response = await fetch(`/panel/ventas/api/aprobar-devolucion/${devolucionIdActual}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ 
                decision: 'RECHAZADA',
                observaciones: observaciones
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Devoluci√≥n rechazada');
            location.reload();
        } else {
            alert('Error al rechazar: ' + (data.error || 'Error desconocido'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al rechazar la devoluci√≥n');
    }
}

// Limpiar formulario al cerrar modal
document.getElementById('modalNuevaDevolucion')?.addEventListener('hidden.bs.modal', function () {
    document.getElementById('formDevolucion').reset();
    document.getElementById('infoVenta').style.display = 'none';
    document.getElementById('productosSection').style.display = 'none';
    document.getElementById('cantidadSection').style.display = 'none';
    ventaActual = null;
    productoSeleccionado = null;
});
</script>
{% endblock %}