{% extends 'custom_admin/base_admin.html' %}
{% load static %}

{% block title %}Dashboard de Ventas - CommerceBox{% endblock %}

{% block extra_css %}
<style>
    /* ============================================
       VARIABLES Y BASE
       ============================================ */
    :root {
        --primary-blue: #3b82f6;
        --primary-blue-light: #60a5fa;
        --primary-blue-dark: #2563eb;
        --success-green: #10b981;
        --warning-orange: #f59e0b;
        --danger-red: #ef4444;
        --purple: #8b5cf6;
        --pink: #ec4899;
        --dark: #0f172a;
        --gray: #64748b;
        --gray-light: #f8fafc;
    }

    /* ============================================
       HEADER PRINCIPAL
       ============================================ */
    .dashboard-header {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
        color: white;
    }

    .dashboard-header h1 {
        font-size: 2rem;
        font-weight: 800;
        margin: 0 0 0.5rem 0;
        color: white;
    }

    .dashboard-header p {
        margin: 0;
        opacity: 0.95;
        font-weight: 500;
    }

    /* ============================================
       FILTROS
       ============================================ */
    .filter-bar {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .filter-bar .form-label {
        font-weight: 700;
        color: var(--dark);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .filter-bar .form-select,
    .filter-bar .form-control {
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        padding: 0.6rem 1rem;
        transition: all 0.3s ease;
    }

    .filter-bar .form-select:focus,
    .filter-bar .form-control:focus {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* ============================================
       KPI CARDS
       ============================================ */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .kpi-card {
        background: white;
        border-radius: 16px;
        padding: 1.75rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-blue), var(--purple));
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .kpi-card:hover::before {
        transform: scaleX(1);
    }

    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(59, 130, 246, 0.2);
    }

    .kpi-label {
        color: var(--gray);
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.75rem;
    }

    .kpi-value {
        color: var(--dark);
        font-size: 2rem;
        font-weight: 800;
        margin: 0.5rem 0;
        line-height: 1;
    }

    .kpi-change {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray);
    }

    .kpi-change.positive {
        color: var(--success-green);
    }

    .kpi-change.negative {
        color: var(--danger-red);
    }

    /* ============================================
       SECTION CARDS (para gr√°ficos)
       ============================================ */
    .section-card {
        background: white;
        border-radius: 16px;
        padding: 1.75rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        height: 100%;
    }

    .section-title {
        color: var(--dark);
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0 0 1.25rem 0;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f1f5f9;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title i {
        color: var(--primary-blue);
    }

    /* ============================================
       CHARTS - TAMA√ëOS OPTIMIZADOS
       ============================================ */
    .chart-container {
        position: relative;
        height: 300px;
    }

    .chart-xl {
        height: 380px;
    }

    .chart-lg {
        height: 320px;
    }

    .chart-md {
        height: 280px;
    }

    .chart-sm {
        height: 240px;
    }

    /* ============================================
       GRIDS OPTIMIZADOS
       ============================================ */
    .grid-full {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .grid-2-1 {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    /* ============================================
       BOTONES
       ============================================ */
    .btn-primary-custom {
        padding: 0.6rem 1.2rem;
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
    }

    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
        color: white;
    }

    .btn-secondary-custom {
        padding: 0.6rem 1.2rem;
        background: white;
        border: 2px solid var(--primary-blue);
        border-radius: 10px;
        color: var(--primary-blue);
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-secondary-custom:hover {
        background: var(--primary-blue);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
    }

    /* ============================================
       TABLA
       ============================================ */
    .table-dashboard {
        width: 100%;
        margin: 0;
    }

    .table-dashboard thead {
        background: #f8fafc;
    }

    .table-dashboard th {
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
        color: var(--gray);
        padding: 1rem;
        letter-spacing: 0.5px;
    }

    .table-dashboard td {
        padding: 1rem;
        color: var(--dark);
    }

    .table-dashboard tbody tr {
        transition: all 0.2s ease;
    }

    .table-dashboard tbody tr:hover {
        background-color: #f8fafc;
    }

    /* ============================================
       BADGES
       ============================================ */
    .ranking-badge {
        display: inline-block;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        text-align: center;
        line-height: 32px;
        font-weight: 700;
        font-size: 0.875rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .ranking-badge.gold {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: white;
    }

    .ranking-badge.silver {
        background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
        color: white;
    }

    .ranking-badge.bronze {
        background: linear-gradient(135deg, #CD7F32, #A0522D);
        color: white;
    }

    .ranking-badge.default {
        background: #e9ecef;
        color: #666;
    }

    /* ============================================
       ALERTAS
       ============================================ */
    .alert-custom {
        padding: 1rem 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .alert-info {
        background: #dbeafe;
        color: #1e40af;
        border: 2px solid #93c5fd;
    }

    .alert-danger {
        background: #fee2e2;
        color: #991b1b;
        border: 2px solid #fca5a5;
    }

    .alert-success {
        background: #d1fae5;
        color: #065f46;
        border: 2px solid #6ee7b7;
    }

    /* ============================================
       ANIMACIONES
       ============================================ */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    .kpi-card,
    .section-card {
        animation: fadeInUp 0.5s ease-out backwards;
    }

    .kpi-card:nth-child(1) { animation-delay: 0.05s; }
    .kpi-card:nth-child(2) { animation-delay: 0.1s; }
    .kpi-card:nth-child(3) { animation-delay: 0.15s; }
    .kpi-card:nth-child(4) { animation-delay: 0.2s; }
    .kpi-card:nth-child(5) { animation-delay: 0.25s; }

    /* ============================================
       RESPONSIVE
       ============================================ */
    @media (max-width: 1200px) {
        .grid-3 {
            grid-template-columns: repeat(2, 1fr);
        }
        .grid-2-1 {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .dashboard-header h1 {
            font-size: 1.5rem;
        }

        .kpi-value {
            font-size: 1.6rem;
        }

        .grid-2,
        .grid-3 {
            grid-template-columns: 1fr;
        }

        .chart-container,
        .chart-xl,
        .chart-lg,
        .chart-md {
            height: 280px;
        }

        .chart-sm {
            height: 240px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- =====================================================
         HEADER
    ===================================================== -->
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    Dashboard de Ventas
                </h1>
                <p>An√°lisis completo de ventas con gr√°ficos en tiempo real</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn-secondary-custom me-2" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Actualizar
                </button>
                <a href="{% url 'reports_analytics:dashboard' %}" class="btn-secondary-custom">
                    <i class="bi bi-arrow-left"></i>
                    Volver
                </a>
            </div>
        </div>
    </div>

    <!-- =====================================================
         FILTROS
    ===================================================== -->
    <div class="filter-bar">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Per√≠odo</label>
                <select class="form-select" id="periodoRapido">
                    <option value="hoy">Hoy</option>
                    <option value="ayer">Ayer</option>
                    <option value="semana">Esta Semana</option>
                    <option value="mes" selected>Este Mes</option>
                    <option value="mes_anterior">Mes Anterior</option>
                    <option value="trimestre">Este Trimestre</option>
                    <option value="anio">Este A√±o</option>
                    <option value="personalizado">Personalizado</option>
                </select>
            </div>
            <div class="col-md-2" id="fechaDesdeContainer" style="display: none;">
                <label class="form-label">Desde</label>
                <input type="date" class="form-control" id="fechaDesde">
            </div>
            <div class="col-md-2" id="fechaHastaContainer" style="display: none;">
                <label class="form-label">Hasta</label>
                <input type="date" class="form-control" id="fechaHasta">
            </div>
            <div class="col-md-2">
                <button class="btn-primary-custom w-100" onclick="aplicarFiltros()">
                    <i class="bi bi-funnel-fill"></i>
                    Aplicar
                </button>
            </div>
        </div>
    </div>

    <!-- Alertas -->
    <div id="alertaCarga" class="alert-custom alert-info" style="display: none;">
        <i class="bi bi-arrow-clockwise" style="animation: spin 1s linear infinite;"></i>
        Cargando datos...
    </div>

    <div id="alertaError" class="alert-custom alert-danger" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <span id="mensajeError"></span>
    </div>

    <!-- =====================================================
         KPIS PRINCIPALES
    ===================================================== -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">Total Ventas</div>
            <div class="kpi-value" id="kpiTotalVentas">$0.00</div>
            <div class="kpi-change" id="kpiTotalVentasChange">
                <i class="bi bi-arrow-up"></i>
                <span>0% vs anterior</span>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">N√∫mero de Ventas</div>
            <div class="kpi-value" id="kpiNumeroVentas">0</div>
            <div class="kpi-change">Tickets procesados</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">Ticket Promedio</div>
            <div class="kpi-value" id="kpiTicketPromedio">$0.00</div>
            <div class="kpi-change" id="kpiTicketChange">
                <i class="bi bi-arrow-up"></i>
                <span>0% vs anterior</span>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">Utilidad Bruta</div>
            <div class="kpi-value" id="kpiUtilidad">$0.00</div>
            <div class="kpi-change" id="kpiMargen">Margen: 0%</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">IVA Recaudado</div>
            <div class="kpi-value" id="kpiIVA">$0.00</div>
            <div class="kpi-change">Total impuestos</div>
        </div>
    </div>

    <!-- =====================================================
         TENDENCIA DE VENTAS DIARIAS (DESTACADO)
    ===================================================== -->
    <div class="grid-full">
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-graph-up"></i>
                Tendencia de Ventas Diarias
            </div>
            <div class="chart-container chart-xl">
                <canvas id="chartVentasDiarias"></canvas>
            </div>
        </div>
    </div>

    <!-- =====================================================
         FILA 1: PRODUCTOS TOP + CATEGOR√çAS + VENDEDORES
    ===================================================== -->
    <div class="grid-3">
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-trophy-fill"></i>
                Top 10 Productos
            </div>
            <div class="chart-container chart-lg">
                <canvas id="chartProductosTop"></canvas>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-tags-fill"></i>
                Ventas por Categor√≠a
            </div>
            <div class="chart-container chart-lg">
                <canvas id="chartCategorias"></canvas>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-person-check-fill"></i>
                Vendedores
            </div>
            <div class="chart-container chart-lg">
                <canvas id="chartVendedores"></canvas>
            </div>
        </div>
    </div>

    <!-- =====================================================
         FILA 2: AN√ÅLISIS DE PAGOS Y PRODUCTOS (COMPACTOS)
    ===================================================== -->
    <div class="grid-3">
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-credit-card-fill"></i>
                Formas de Pago
            </div>
            <div class="chart-container chart-sm">
                <canvas id="chartFormasPago"></canvas>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-arrow-left-right"></i>
                Contado vs Cr√©dito
            </div>
            <div class="chart-container chart-sm">
                <canvas id="chartTipoVenta"></canvas>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-box-seam-fill"></i>
                Tipo de Producto
            </div>
            <div class="chart-container chart-sm">
                <canvas id="chartTipoProducto"></canvas>
            </div>
        </div>
    </div>

    <!-- =====================================================
         FILA 3: HORARIOS DE VENTA
    ===================================================== -->
    <div class="grid-2">
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-clock-fill"></i>
                Ventas por Hora del D√≠a
            </div>
            <div class="chart-container chart-md">
                <canvas id="chartVentasHora"></canvas>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-calendar-week-fill"></i>
                Ventas por D√≠a de Semana
            </div>
            <div class="chart-container chart-md">
                <canvas id="chartVentasDiaSemana"></canvas>
            </div>
        </div>
    </div>

    <!-- =====================================================
         TOP CLIENTES (TABLA)
    ===================================================== -->
    <div class="grid-full">
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-people-fill"></i>
                Top 20 Clientes del Per√≠odo
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-dashboard" id="tablaClientes">
                    <thead>
                        <tr>
                            <th style="width: 60px;">#</th>
                            <th>Cliente</th>
                            <th style="width: 140px;">Documento</th>
                            <th style="width: 100px;">Tipo</th>
                            <th class="text-end" style="width: 130px;">Total Compras</th>
                            <th class="text-end" style="width: 100px;"># Compras</th>
                            <th class="text-end" style="width: 130px;">Ticket Prom.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <i class="bi bi-hourglass-split me-2"></i>Cargando datos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- =====================================================
         COMPARATIVO CON PER√çODO ANTERIOR
    ===================================================== -->
    <div class="grid-full">
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-bar-chart-fill"></i>
                Comparativo con Per√≠odo Anterior
            </div>
            <div class="chart-container chart-md">
                <canvas id="chartComparativo"></canvas>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// (El JavaScript permanece igual que antes, no hay cambios necesarios)
console.log('üöÄ Iniciando Dashboard de Ventas...');

let filtrosGlobales = {
    fecha_desde: null,
    fecha_hasta: null
};

let chartInstances = {};

// =====================================================
// INICIALIZACI√ìN
// =====================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM cargado');
    
    const hoy = new Date();
    const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    
    filtrosGlobales.fecha_desde = formatearFecha(primerDiaMes);
    filtrosGlobales.fecha_hasta = formatearFecha(hoy);
    
    document.getElementById('fechaDesde').valueAsDate = primerDiaMes;
    document.getElementById('fechaHasta').valueAsDate = hoy;
    
    document.getElementById('periodoRapido').addEventListener('change', function() {
        if (this.value === 'personalizado') {
            document.getElementById('fechaDesdeContainer').style.display = 'block';
            document.getElementById('fechaHastaContainer').style.display = 'block';
        } else {
            document.getElementById('fechaDesdeContainer').style.display = 'none';
            document.getElementById('fechaHastaContainer').style.display = 'none';
        }
    });
    
    cargarDashboardCompleto();
});

// =====================================================
// FUNCIONES DE UTILIDAD
// =====================================================

function formatearFecha(fecha) {
    const a√±o = fecha.getFullYear();
    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
    const dia = String(fecha.getDate()).padStart(2, '0');
    return `${a√±o}-${mes}-${dia}`;
}

function formatearMoneda(valor) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(valor || 0);
}

function formatearNumero(valor, decimales = 2) {
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: decimales,
        maximumFractionDigits: decimales
    }).format(valor || 0);
}

function mostrarAlerta(mensaje, tipo = 'info') {
    const alerta = document.getElementById(tipo === 'error' ? 'alertaError' : 'alertaCarga');
    if (tipo === 'error') {
        document.getElementById('mensajeError').textContent = mensaje;
    }
    alerta.style.display = 'flex';
}

function ocultarAlertas() {
    document.getElementById('alertaCarga').style.display = 'none';
    document.getElementById('alertaError').style.display = 'none';
}

function aplicarFiltros() {
    const periodo = document.getElementById('periodoRapido').value;
    
    if (periodo === 'personalizado') {
        const fechaDesde = document.getElementById('fechaDesde').value;
        const fechaHasta = document.getElementById('fechaHasta').value;
        
        if (!fechaDesde || !fechaHasta) {
            alert('Por favor seleccione ambas fechas');
            return;
        }
        
        filtrosGlobales.fecha_desde = fechaDesde;
        filtrosGlobales.fecha_hasta = fechaHasta;
    } else {
        const fechas = calcularFechasPeriodo(periodo);
        filtrosGlobales.fecha_desde = fechas.desde;
        filtrosGlobales.fecha_hasta = fechas.hasta;
    }
    
    console.log('üîç Filtros aplicados:', filtrosGlobales);
    cargarDashboardCompleto();
}

function calcularFechasPeriodo(periodo) {
    const hoy = new Date();
    let fechaDesde, fechaHasta = hoy;
    
    switch(periodo) {
        case 'hoy':
            fechaDesde = hoy;
            break;
        case 'ayer':
            fechaDesde = new Date(hoy);
            fechaDesde.setDate(hoy.getDate() - 1);
            fechaHasta = fechaDesde;
            break;
        case 'semana':
            fechaDesde = new Date(hoy);
            fechaDesde.setDate(hoy.getDate() - hoy.getDay());
            break;
        case 'mes':
            fechaDesde = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            break;
        case 'mes_anterior':
            fechaDesde = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
            fechaHasta = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
            break;
        case 'trimestre':
            const mesActual = hoy.getMonth();
            const primerMesTrimestre = Math.floor(mesActual / 3) * 3;
            fechaDesde = new Date(hoy.getFullYear(), primerMesTrimestre, 1);
            break;
        case 'anio':
            fechaDesde = new Date(hoy.getFullYear(), 0, 1);
            break;
        default:
            fechaDesde = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    }
    
    return {
        desde: formatearFecha(fechaDesde),
        hasta: formatearFecha(fechaHasta)
    };
}

function destruirGraficos() {
    Object.values(chartInstances).forEach(chart => {
        if (chart) chart.destroy();
    });
    chartInstances = {};
}

// =====================================================
// CARGA DEL DASHBOARD
// =====================================================

async function cargarDashboardCompleto() {
    console.log('üì• Cargando dashboard...');
    mostrarAlerta('Cargando datos...', 'info');
    
    try {
        destruirGraficos();
        
        const params = `?fecha_desde=${filtrosGlobales.fecha_desde}&fecha_hasta=${filtrosGlobales.fecha_hasta}`;
        
        const urls = {
            periodo: `/panel/reportes-analitica/api/ventas/periodo/${params}`,
            diarias: `/panel/reportes-analitica/api/ventas/diarias/${params}`,
            productos: `/panel/reportes-analitica/api/ventas/productos-top/${params}`,
            categorias: `/panel/reportes-analitica/api/ventas/categorias/${params}`,
            vendedores: `/panel/reportes-analitica/api/ventas/vendedores/${params}`,
            clientes: `/panel/reportes-analitica/api/ventas/clientes-top/${params}`,
            horarios: `/panel/reportes-analitica/api/ventas/horarios/${params}`,
            comparativo: `/panel/reportes-analitica/api/ventas/comparativo/${params}`
        };
        
        console.log('üì° URLs a consultar:', urls);
        
        const [periodo, diarias, productosTop, categorias, vendedores, clientes, horarios, comparativo] = await Promise.all([
            fetch(urls.periodo).then(r => r.json()),
            fetch(urls.diarias).then(r => r.json()),
            fetch(urls.productos).then(r => r.json()),
            fetch(urls.categorias).then(r => r.json()),
            fetch(urls.vendedores).then(r => r.json()),
            fetch(urls.clientes).then(r => r.json()),
            fetch(urls.horarios).then(r => r.json()),
            fetch(urls.comparativo).then(r => r.json())
        ]);
        
        console.log('üìä Datos recibidos correctamente');
        
        actualizarKPIs(periodo, comparativo);
        crearGraficoVentasDiarias(diarias.ventas_diarias || []);
        crearGraficoProductosTop(productosTop.productos || []);
        crearGraficoCategorias(categorias.categorias || []);
        crearGraficoFormasPago(periodo.formas_pago || []);
        crearGraficoTipoVenta(periodo.por_tipo_venta || []);
        crearGraficoTipoProducto(periodo.por_tipo_producto || {});
        crearGraficoVendedores(vendedores.vendedores || []);
        crearTablaClientes(clientes.clientes || []);
        crearGraficoVentasHora(horarios.ventas_por_hora || []);
        crearGraficoVentasDiaSemana(horarios.ventas_por_dia_semana || []);
        crearGraficoComparativo(comparativo);
        
        ocultarAlertas();
        console.log('‚úÖ Dashboard cargado');
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        console.error('‚ùå Stack:', error.stack);
        mostrarAlerta('Error al cargar el dashboard: ' + error.message, 'error');
    }
}

// =====================================================
// ACTUALIZAR KPIs
// =====================================================

function actualizarKPIs(periodo, comparativo) {
    document.getElementById('kpiTotalVentas').textContent = formatearMoneda(periodo.metricas_generales.total_ventas);
    document.getElementById('kpiNumeroVentas').textContent = periodo.metricas_generales.cantidad_ventas;
    document.getElementById('kpiTicketPromedio').textContent = formatearMoneda(periodo.metricas_generales.ticket_promedio);
    document.getElementById('kpiUtilidad').textContent = formatearMoneda(periodo.rentabilidad.utilidad_bruta);
    document.getElementById('kpiMargen').textContent = `Margen: ${formatearNumero(periodo.rentabilidad.margen_porcentaje)}%`;
    document.getElementById('kpiIVA').textContent = formatearMoneda(periodo.metricas_generales.total_iva_recaudado);
    
    const varVentas = comparativo.variaciones.ventas_porcentaje;
    const iconVentas = varVentas >= 0 ? 'arrow-up' : 'arrow-down';
    document.getElementById('kpiTotalVentasChange').innerHTML = `
        <i class="bi bi-${iconVentas}"></i>
        <span>${Math.abs(varVentas).toFixed(1)}% vs anterior</span>
    `;
    document.getElementById('kpiTotalVentasChange').className = `kpi-change ${varVentas >= 0 ? 'positive' : 'negative'}`;
    
    const varTicket = comparativo.variaciones.ticket_porcentaje;
    const iconTicket = varTicket >= 0 ? 'arrow-up' : 'arrow-down';
    document.getElementById('kpiTicketChange').innerHTML = `
        <i class="bi bi-${iconTicket}"></i>
        <span>${Math.abs(varTicket).toFixed(1)}% vs anterior</span>
    `;
    document.getElementById('kpiTicketChange').className = `kpi-change ${varTicket >= 0 ? 'positive' : 'negative'}`;
}

// =====================================================
// CREAR GR√ÅFICOS
// =====================================================

function crearGraficoVentasDiarias(data) {
    const ctx = document.getElementById('chartVentasDiarias');
    if (!ctx || !data || data.length === 0) return;
    
    const tipoGrafico = data.length <= 2 ? 'bar' : 'line';
    
    const labels = data.map(d => {
        const fecha = new Date(d.fecha);
        return fecha.toLocaleDateString('es-BO', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric' 
        });
    });
    
    const valores = data.map(d => d.total_ventas);
    
    const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
    gradient.addColorStop(1, 'rgba(59, 130, 246, 0.01)');
    
    const config = {
        type: tipoGrafico,
        data: {
            labels: labels,
            datasets: [{
                label: 'Ventas',
                data: valores,
                borderColor: '#3b82f6',
                backgroundColor: tipoGrafico === 'line' ? gradient : 'rgba(59, 130, 246, 0.8)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: data.length <= 5 ? 8 : 5,
                pointHoverRadius: data.length <= 5 ? 12 : 7,
                pointBackgroundColor: '#3b82f6',
                pointBorderColor: '#fff',
                pointBorderWidth: 3,
                borderRadius: tipoGrafico === 'bar' ? 12 : undefined,
                barThickness: data.length === 1 ? 80 : (data.length === 2 ? 60 : undefined)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    titleColor: '#fff',
                    bodyColor: '#e2e8f0',
                    borderColor: 'rgba(59, 130, 246, 0.5)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: false,
                    titleFont: { size: 13, weight: '700' },
                    bodyFont: { size: 14, weight: '600' },
                    callbacks: {
                        label: ctx => 'Ventas: ' + formatearMoneda(ctx.parsed.y)
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { 
                        color: 'rgba(148, 163, 184, 0.1)',
                        drawBorder: false
                    },
                    border: { display: false },
                    ticks: {
                        color: '#64748b',
                        font: { size: 11, weight: '600' },
                        padding: 8,
                        callback: value => formatearMoneda(value)
                    }
                },
                x: {
                    grid: { display: false },
                    border: { display: false },
                    ticks: { 
                        color: '#64748b', 
                        font: { size: 11, weight: '600' },
                        maxRotation: 45,
                        minRotation: 0
                    }
                }
            },
            animation: {
                duration: 1200,
                easing: 'easeInOutQuart'
            }
        }
    };
    
    chartInstances.ventasDiarias = new Chart(ctx, config);
    
    if (data.length <= 2) {
        console.log(`‚ÑπÔ∏è Solo hay ${data.length} d√≠a(s) de datos - usando gr√°fico de barras`);
    }
}

function crearGraficoProductosTop(data) {
    const ctx = document.getElementById('chartProductosTop');
    if (!ctx || !data || data.length === 0) return;
    
    chartInstances.productosTop = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.slice(0, 10).map(p => (p.producto__nombre || 'Sin nombre').substring(0, 20)),
            datasets: [{
                label: 'Total',
                data: data.slice(0, 10).map(p => p.total_vendido),
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: '#3b82f6',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    callbacks: {
                        label: ctx => formatearMoneda(ctx.parsed.x)
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#64748b',
                        font: { size: 10 },
                        callback: value => formatearMoneda(value)
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: { 
                        color: '#64748b',
                        font: { size: 10 }
                    }
                }
            }
        }
    });
}

function crearGraficoCategorias(data) {
    const ctx = document.getElementById('chartCategorias');
    if (!ctx || !data || data.length === 0) return;
    
    chartInstances.categorias = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(c => c.categoria),
            datasets: [{
                data: data.map(c => c.total_ventas),
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(236, 72, 153, 0.8)'
                ],
                borderColor: '#fff',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 8,
                        font: { size: 10, weight: '600' },
                        color: '#64748b'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    callbacks: {
                        label: ctx => ctx.label + ': ' + formatearMoneda(ctx.parsed)
                    }
                }
            }
        }
    });
}

function crearGraficoFormasPago(data) {
    const ctx = document.getElementById('chartFormasPago');
    if (!ctx || !data || data.length === 0) return;
    
    chartInstances.formasPago = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.map(p => p.forma_pago),
            datasets: [{
                data: data.map(p => p.total),
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(139, 92, 246, 0.8)'
                ],
                borderColor: '#fff',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 8,
                        font: { size: 10, weight: '600' },
                        color: '#64748b'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    callbacks: {
                        label: ctx => ctx.label + ': ' + formatearMoneda(ctx.parsed)
                    }
                }
            }
        }
    });
}

function crearGraficoTipoVenta(data) {
    const ctx = document.getElementById('chartTipoVenta');
    if (!ctx || !data || data.length === 0) return;
    
    chartInstances.tipoVenta = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(t => t.tipo_venta),
            datasets: [{
                data: data.map(t => t.total),
                backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)'],
                borderColor: '#fff',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 8,
                        font: { size: 10, weight: '600' },
                        color: '#64748b'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    callbacks: {
                        label: ctx => ctx.label + ': ' + formatearMoneda(ctx.parsed)
                    }
                }
            }
        }
    });
}

function crearGraficoTipoProducto(data) {
    const ctx = document.getElementById('chartTipoProducto');
    if (!ctx || !data) return;
    
    chartInstances.tipoProducto = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Quintales', 'Productos'],
            datasets: [{
                data: [data.quintales?.total || 0, data.productos_normales?.total || 0],
                backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(139, 92, 246, 0.8)'],
                borderColor: '#fff',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 8,
                        font: { size: 10, weight: '600' },
                        color: '#64748b'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    callbacks: {
                        label: ctx => ctx.label + ': ' + formatearMoneda(ctx.parsed)
                    }
                }
            }
        }
    });
}

function crearGraficoVendedores(data) {
    const ctx = document.getElementById('chartVendedores');
    if (!ctx || !data || data.length === 0) return;
    
    chartInstances.vendedores = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(v => v.vendedor.split(' ')[0]),  // Solo primer nombre
            datasets: [{
                label: 'Ventas',
                data: data.map(v => v.total_ventas),
                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                borderColor: '#10b981',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    callbacks: {
                        title: (items) => data[items[0].dataIndex].vendedor,  // Nombre completo en tooltip
                        label: ctx => formatearMoneda(ctx.parsed.y)
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#64748b',
                        font: { size: 10 },
                        callback: value => formatearMoneda(value)
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { 
                        color: '#64748b',
                        font: { size: 10 }
                    }
                }
            }
        }
    });
}

function crearTablaClientes(data) {
    const tbody = document.querySelector('#tablaClientes tbody');
    if (!tbody) return;
    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><i class="bi bi-inbox me-2"></i>No hay datos disponibles</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(c => `
        <tr>
            <td>
                <span class="ranking-badge ${c.ranking <= 3 ? (c.ranking === 1 ? 'gold' : c.ranking === 2 ? 'silver' : 'bronze') : 'default'}">
                    ${c.ranking}
                </span>
            </td>
            <td><strong>${c.cliente}</strong></td>
            <td><span class="text-muted">${c.documento}</span></td>
            <td><span class="badge bg-primary">${c.tipo_cliente}</span></td>
            <td class="text-end"><strong>${formatearMoneda(c.total_compras)}</strong></td>
            <td class="text-end"><span class="badge bg-secondary">${c.cantidad_compras}</span></td>
            <td class="text-end">${formatearMoneda(c.ticket_promedio)}</td>
        </tr>
    `).join('');
}

function crearGraficoVentasHora(data) {
    const ctx = document.getElementById('chartVentasHora');
    if (!ctx || !data || data.length === 0) return;
    
    chartInstances.ventasHora = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(h => h.hora + ':00'),
            datasets: [{
                label: 'Ventas',
                data: data.map(h => h.total),
                backgroundColor: 'rgba(139, 92, 246, 0.8)',
                borderColor: '#8b5cf6',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    callbacks: {
                        label: ctx => formatearMoneda(ctx.parsed.y)
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#64748b',
                        callback: value => formatearMoneda(value)
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#64748b' }
                }
            }
        }
    });
}

function crearGraficoVentasDiaSemana(data) {
    const ctx = document.getElementById('chartVentasDiaSemana');
    if (!ctx || !data || data.length === 0) return;
    
    chartInstances.ventasDiaSemana = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => d.dia_nombre),
            datasets: [{
                label: 'Ventas',
                data: data.map(d => d.total),
                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                borderColor: '#10b981',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    callbacks: {
                        label: ctx => formatearMoneda(ctx.parsed.y)
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#64748b',
                        callback: value => formatearMoneda(value)
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#64748b' }
                }
            }
        }
    });
}

function crearGraficoComparativo(data) {
    const ctx = document.getElementById('chartComparativo');
    if (!ctx || !data) return;
    
    chartInstances.comparativo = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Total Ventas', 'Cantidad', 'Ticket Promedio'],
            datasets: [
                {
                    label: 'Per√≠odo Actual',
                    data: [
                        data.periodo_actual.total_ventas,
                        data.periodo_actual.cantidad_ventas,
                        data.periodo_actual.ticket_promedio
                    ],
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    borderRadius: 8
                },
                {
                    label: 'Per√≠odo Anterior',
                    data: [
                        data.periodo_anterior.total_ventas,
                        data.periodo_anterior.cantidad_ventas,
                        data.periodo_anterior.ticket_promedio
                    ],
                    backgroundColor: 'rgba(148, 163, 184, 0.5)',
                    borderColor: '#94a3b8',
                    borderWidth: 2,
                    borderRadius: 8
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        padding: 15,
                        font: { size: 12, weight: '600' },
                        color: '#64748b'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: { color: '#64748b' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#64748b', font: { weight: '600' } }
                }
            }
        }
    });
}
</script>
{% endblock %}