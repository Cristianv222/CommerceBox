{% extends 'custom_admin/base_admin.html' %}
{% load static %}

{% block title %}Punto de Venta - CommerceBox{% endblock %}

{% block extra_css %}
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* ============================================
       LAYOUT CON CARRITO PROTAGONISTA
       ============================================ */
    .pos-container {
        display: grid;
        grid-template-columns: 320px 1fr 420px;
        gap: 1rem;
        height: calc(100vh - 100px);
        margin: -1rem;
        padding: 0.5rem;
    }
    
    .productos-panel {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        overflow: hidden;
        height: 100%;
    }
    
    .carrito-panel {
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100%;
    }
    
    .opciones-panel {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        overflow: hidden;
        height: 100%;
    }
    
    /* ============================================
       CARDS OPTIMIZADOS
       ============================================ */
    .pos-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(30px) saturate(180%);
        border: 1px solid rgba(219, 234, 254, 0.5);
        border-radius: 16px;
        padding: 1.2rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.08);
    }
    
    .pos-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(ellipse 400px 300px at 50% 50%, rgba(219, 234, 254, 0.08) 0%, transparent 60%);
        pointer-events: none;
        z-index: 0;
    }
    
    .pos-card-content {
        position: relative;
        z-index: 2;
    }
    
    .pos-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.8rem;
        border-bottom: 2px solid rgba(59, 130, 246, 0.1);
    }
    
    .pos-card-title {
        font-size: 1.1rem;
        font-weight: 800;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    /* ============================================
       BÚSQUEDA - MÁS COMPACTA
       ============================================ */
    .search-container {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 0.6rem;
    }
    
    .search-input-wrapper {
        position: relative;
    }
    
    .search-input {
        width: 100%;
        padding: 7px 10px 7px 32px;
        background: rgba(248, 250, 252, 0.6);
        border: 1.5px solid rgba(203, 213, 225, 0.5);
        border-radius: 8px;
        color: #1e293b;
        font-size: 0.8rem;
        transition: all 0.3s ease;
    }
    
    .search-input:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.9);
        border-color: rgba(96, 165, 250, 0.6);
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.08);
    }
    
    .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 0.85rem;
    }
    
    .categoria-select {
        width: 100%;
        padding: 7px 10px;
        background: rgba(248, 250, 252, 0.6);
        border: 1.5px solid rgba(203, 213, 225, 0.5);
        border-radius: 8px;
        color: #1e293b;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .categoria-select:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.9);
        border-color: rgba(96, 165, 250, 0.6);
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.08);
    }
    
    .btn-mostrar-todos {
        width: 100%;
        padding: 7px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.95) 0%, rgba(37, 99, 235, 0.95) 100%);
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 700;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
    }
    
    .btn-mostrar-todos:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
    }
    
    /* ============================================
       LISTA DE PRODUCTOS - COMPACTA
       ============================================ */
    .productos-lista {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        padding-right: 0.3rem;
    }
    
    .producto-item {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(219, 234, 254, 0.5);
        border-radius: 8px;
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.4rem;
    }
    
    .producto-item:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        border-color: rgba(96, 165, 250, 0.6);
        background: rgba(255, 255, 255, 1);
    }
    
    .producto-item.sin-stock {
        opacity: 0.5;
        cursor: not-allowed;
        background: rgba(239, 68, 68, 0.05);
        border-color: rgba(239, 68, 68, 0.2);
    }
    
    .producto-item.sin-stock:hover {
        transform: none;
        box-shadow: none;
    }
    
    .producto-info {
        flex: 1;
        min-width: 0;
    }
    
    .producto-nombre {
        font-weight: 700;
        color: #0f172a;
        font-size: 0.75rem;
        margin-bottom: 0.15rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .producto-codigo {
        font-size: 0.6rem;
        color: #64748b;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.3rem;
        flex-wrap: wrap;
    }
    
    .stock-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
        padding: 0.1rem 0.3rem;
        border-radius: 4px;
        font-size: 0.55rem;
        font-weight: 700;
    }
    
    .stock-badge.disponible {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
    }
    
    .stock-badge.bajo {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
    }
    
    .stock-badge.agotado {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
    }
    
    .producto-precio {
        font-size: 0.85rem;
        font-weight: 800;
        color: #10b981;
        white-space: nowrap;
    }
    
    .productos-empty {
        text-align: center;
        padding: 2rem 1rem;
        color: #94a3b8;
    }
    
    /* ============================================
       ALERTAS
       ============================================ */
    .alert-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        min-width: 300px;
        max-width: 500px;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        z-index: 99999;
        animation: slideInRight 0.3s ease-out;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
    
    .alert-toast.hiding {
        animation: slideOutRight 0.3s ease-out forwards;
    }
    
    .alert-toast.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .alert-toast.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }
    
    .alert-toast.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .alert-toast.info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
    }
    
    .alert-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .alert-content {
        flex: 1;
    }
    
    .alert-title {
        font-weight: 700;
        font-size: 0.95rem;
        margin-bottom: 0.2rem;
    }
    
    .alert-message {
        font-size: 0.85rem;
        opacity: 0.95;
    }
    
    .alert-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    
    .alert-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }
    
    /* ============================================
       CARRITO PROTAGONISTA - DISEÑO DESTACADO
       ============================================ */
    .carrito-card-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        /* Efecto de destacado */
        box-shadow: 0 8px 32px rgba(59, 130, 246, 0.12) !important;
        border: 2px solid rgba(59, 130, 246, 0.2) !important;
    }
    
    .carrito-content-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }
    
    .carrito-items {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 0.6rem;
        min-height: 0;
    }
    
    .carrito-item {
        background: rgba(248, 250, 252, 0.7);
        border: 1px solid rgba(219, 234, 254, 0.5);
        border-radius: 10px;
        padding: 0.8rem;
        margin-bottom: 0.7rem;
        transition: all 0.2s;
    }
    
    .carrito-item:hover {
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        transform: translateY(-2px);
    }
    
    .carrito-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.6rem;
        padding-bottom: 0.6rem;
        border-bottom: 1px solid rgba(219, 234, 254, 0.4);
    }
    
    .carrito-item-info {
        flex: 1;
    }
    
    .carrito-item-nombre {
        font-weight: 800;
        color: #0f172a;
        font-size: 0.95rem;
        margin-bottom: 0.2rem;
    }
    
    .carrito-item-codigo {
        font-size: 0.7rem;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }
    
    .carrito-item-unidad {
        display: inline-block;
        background: rgba(59, 130, 246, 0.12);
        color: #3b82f6;
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 700;
    }
    
    .carrito-item-eliminar {
        background: rgba(239, 68, 68, 0.12);
        border: none;
        color: #dc2626;
        width: 30px;
        height: 30px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
        flex-shrink: 0;
    }
    
    .carrito-item-eliminar:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: scale(1.08);
    }
    
    /* GRID PARA CAMPOS */
    .carrito-item-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 0.6rem;
    }
    
    .carrito-field {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
    }
    
    .carrito-field-label {
        font-size: 0.65rem;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.4px;
    }
    
    .carrito-field-input {
        padding: 6px 8px;
        background: rgba(255, 255, 255, 0.9);
        border: 1.5px solid rgba(219, 234, 254, 0.6);
        border-radius: 6px;
        font-weight: 700;
        color: #0f172a;
        font-size: 0.85rem;
        transition: all 0.3s;
    }
    
    .carrito-field-input:focus {
        outline: none;
        border-color: rgba(96, 165, 250, 0.7);
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }
    
    .cantidad-control {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        background: rgba(255, 255, 255, 0.9);
        border: 1.5px solid rgba(219, 234, 254, 0.6);
        border-radius: 6px;
        padding: 0.2rem;
    }
    
    .cantidad-btn {
        background: rgba(59, 130, 246, 0.12);
        border: none;
        color: #3b82f6;
        width: 26px;
        height: 26px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: 700;
        transition: all 0.2s;
        font-size: 0.8rem;
        flex-shrink: 0;
    }
    
    .cantidad-btn:hover {
        background: rgba(59, 130, 246, 0.25);
        transform: scale(1.1);
    }
    
    .cantidad-input {
        flex: 1;
        text-align: center;
        border: none;
        background: transparent;
        font-weight: 700;
        color: #0f172a;
        font-size: 0.9rem;
        padding: 0;
        min-width: 0;
    }
    
    /* FOOTER DEL ITEM */
    .carrito-item-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0.6rem;
        border-top: 1px solid rgba(219, 234, 254, 0.4);
        gap: 0.5rem;
    }
    
    .item-total-info {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
    }
    
    .item-total-info span {
        display: flex;
        flex-direction: column;
    }
    
    .item-total-info-label {
        color: #64748b;
        font-size: 0.6rem;
        text-transform: uppercase;
        font-weight: 600;
    }
    
    .item-total-info-value {
        color: #0f172a;
        font-weight: 800;
        font-size: 0.85rem;
    }
    
    .item-total-info-value.descuento {
        color: #dc2626;
    }
    
    .item-total-final {
        text-align: right;
    }
    
    .item-total-final-label {
        font-size: 0.65rem;
        color: #64748b;
        font-weight: 600;
    }
    
    .item-total-final-value {
        font-size: 1.1rem;
        font-weight: 800;
        color: #10b981;
    }
    
    .carrito-empty {
        text-align: center;
        padding: 4rem 1.5rem;
        color: #94a3b8;
    }
    
    .carrito-empty i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    /* ============================================
       TOTALES DESTACADOS
       ============================================ */
    .totales-container {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(37, 99, 235, 0.05) 100%);
        border: 2px solid rgba(59, 130, 246, 0.2);
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
        flex-shrink: 0;
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        color: #1e293b;
        font-size: 1rem;
        font-weight: 600;
    }
    
    .total-row.total-final {
        border-top: 2px solid rgba(59, 130, 246, 0.3);
        margin-top: 0.5rem;
        padding-top: 0.8rem;
        font-size: 1.8rem;
        font-weight: 900;
        color: #0f172a;
    }
    
    /* ============================================
       OPCIONES DE VENTA - COMPACTAS
       ============================================ */
    .opciones-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.6rem;
        margin-bottom: 0.6rem;
    }
    
    .opcion-item {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }
    
    .opcion-label {
        font-size: 0.7rem;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    
    .cliente-select {
        width: 100%;
        padding: 8px 10px;
        background: rgba(248, 250, 252, 0.8);
        border: 1.5px solid rgba(203, 213, 225, 0.5);
        border-radius: 8px;
        color: #1e293b;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .cliente-select:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.95);
        border-color: rgba(96, 165, 250, 0.6);
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.08);
    }
    
    .tipo-venta-selector {
        display: flex;
        gap: 0.4rem;
    }
    
    .tipo-venta-btn {
        flex: 1;
        padding: 8px;
        background: rgba(248, 250, 252, 0.8);
        border: 1.5px solid rgba(203, 213, 225, 0.5);
        border-radius: 8px;
        color: #64748b;
        font-weight: 700;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
    }
    
    .tipo-venta-btn.active {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.95) 0%, rgba(37, 99, 235, 0.95) 100%);
        border-color: transparent;
        color: white;
        box-shadow: 0 3px 12px rgba(59, 130, 246, 0.3);
    }
    
    .metodo-pago-selector {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.4rem;
    }
    
    .metodo-pago-btn {
        padding: 8px;
        background: rgba(248, 250, 252, 0.8);
        border: 1.5px solid rgba(203, 213, 225, 0.5);
        border-radius: 8px;
        color: #64748b;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
        font-size: 0.75rem;
    }
    
    .metodo-pago-btn.active {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.95) 0%, rgba(5, 150, 105, 0.95) 100%);
        border-color: transparent;
        color: white;
        box-shadow: 0 3px 12px rgba(16, 185, 129, 0.3);
    }
    
    /* ============================================
       CAMPOS DE PAGO
       ============================================ */
    .pago-container {
        background: linear-gradient(135deg, rgba(255, 251, 235, 0.7) 0%, rgba(254, 249, 195, 0.5) 100%);
        border: 1.5px solid rgba(251, 191, 36, 0.3);
        border-radius: 10px;
        padding: 0.8rem;
        margin-bottom: 0.6rem;
        display: none;
    }
    
    .pago-container.visible {
        display: block;
    }
    
    .pago-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.6rem;
    }
    
    .pago-item {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }
    
    .pago-label {
        font-size: 0.7rem;
        font-weight: 700;
        color: #92400e;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    
    .pago-input {
        width: 100%;
        padding: 9px 10px;
        background: rgba(255, 255, 255, 0.95);
        border: 1.5px solid rgba(217, 119, 6, 0.3);
        border-radius: 8px;
        font-weight: 800;
        color: #0f172a;
        font-size: 1.05rem;
        transition: all 0.3s;
    }
    
    .pago-input:focus {
        outline: none;
        border-color: rgba(217, 119, 6, 0.6);
        box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.15);
    }
    
    .cambio-box {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.1) 100%);
        border: 2px solid rgba(16, 185, 129, 0.35);
        border-radius: 8px;
        padding: 9px 10px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .cambio-box.negativo {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.1) 100%);
        border-color: rgba(239, 68, 68, 0.35);
    }
    
    .cambio-value {
        font-size: 1.25rem;
        font-weight: 800;
        color: #059669;
    }
    
    .cambio-value.negativo {
        color: #dc2626;
    }
    
    /* ============================================
       BOTONES DE ACCIÓN
       ============================================ */
    .acciones-container {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
    }
    
    .btn-procesar {
        width: 100%;
        padding: 1.1rem;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.95) 0%, rgba(37, 99, 235, 0.95) 100%);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 1.05rem;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.35);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btn-procesar:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.45);
    }
    
    .btn-procesar:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .btn-limpiar {
        width: 100%;
        padding: 0.7rem;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 8px;
        color: #dc2626;
        font-weight: 700;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
    }
    
    .btn-limpiar:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: translateY(-2px);
    }
    
    /* ============================================
       MODAL
       ============================================ */
    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        animation: fadeIn 0.3s ease;
    }
    
    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-dialog {
        width: 90%;
        max-width: 500px;
        animation: slideIn 0.3s ease;
    }
    
    .modal-content {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(30px) saturate(180%);
        border: 1px solid rgba(219, 234, 254, 0.5);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }
    
    .modal-header {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.95) 0%, rgba(5, 150, 105, 0.95) 100%);
        color: white;
        padding: 1.5rem;
        text-align: center;
    }
    
    .modal-header i {
        font-size: 3rem;
        margin-bottom: 0.5rem;
    }
    
    .modal-title {
        font-size: 1.5rem;
        font-weight: 800;
        margin: 0;
    }
    
    .modal-body {
        padding: 2rem;
    }
    
    .venta-info {
        background: rgba(248, 250, 252, 0.6);
        border: 1px solid rgba(219, 234, 254, 0.5);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .venta-info-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(219, 234, 254, 0.3);
    }
    
    .venta-info-row:last-child {
        border-bottom: none;
    }
    
    .venta-info-label {
        color: #64748b;
        font-weight: 600;
    }
    
    .venta-info-value {
        color: #0f172a;
        font-weight: 700;
    }
    
    .venta-total {
        font-size: 2rem;
        color: #10b981;
        font-weight: 800;
    }
    
    .modal-actions {
        display: flex;
        gap: 0.75rem;
    }
    
    .btn-modal {
        flex: 1;
        padding: 1rem;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .btn-modal-primary {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.95) 0%, rgba(37, 99, 235, 0.95) 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-modal-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }
    
    .btn-modal-secondary {
        background: rgba(148, 163, 184, 0.15);
        border: 1px solid rgba(148, 163, 184, 0.3);
        color: #475569;
    }
    
    .btn-modal-secondary:hover {
        background: rgba(148, 163, 184, 0.25);
    }
    
    /* ============================================
       SPINNER
       ============================================ */
    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* ============================================
       SCROLLBAR PERSONALIZADO
       ============================================ */
    .carrito-items::-webkit-scrollbar,
    .productos-lista::-webkit-scrollbar {
        width: 6px;
    }
    
    .carrito-items::-webkit-scrollbar-track,
    .productos-lista::-webkit-scrollbar-track {
        background: rgba(248, 250, 252, 0.5);
        border-radius: 3px;
    }
    
    .carrito-items::-webkit-scrollbar-thumb,
    .productos-lista::-webkit-scrollbar-thumb {
        background: rgba(147, 197, 253, 0.6);
        border-radius: 3px;
    }
    
    .carrito-items::-webkit-scrollbar-thumb:hover,
    .productos-lista::-webkit-scrollbar-thumb:hover {
        background: rgba(96, 165, 250, 0.8);
    }
    
    /* ============================================
       RESPONSIVE
       ============================================ */
    @media (max-width: 1400px) {
        .pos-container {
            grid-template-columns: 300px 1fr 380px;
        }
    }
    
    @media (max-width: 1024px) {
        .pos-container {
            grid-template-columns: 1fr;
            height: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="pos-container">
    <!-- ============================================
         PANEL IZQUIERDO - BÚSQUEDA Y PRODUCTOS (COMPACTO)
         ============================================ -->
    <div class="productos-panel">
        <div class="pos-card">
            <div class="pos-card-content">
                <div class="pos-card-header">
                    <h2 class="pos-card-title">
                        <i class="fas fa-search"></i> Productos
                    </h2>
                </div>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" 
                               id="searchInput" 
                               class="search-input" 
                               placeholder="Buscar..."
                               autocomplete="off">
                    </div>
                    
                    <select id="categoriaFilter" class="categoria-select">
                        <option value="">Todas las categorías</option>
                        {% for categoria in categorias %}
                        <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                        {% endfor %}
                    </select>
                    
                    <button type="button" class="btn-mostrar-todos" onclick="window.cargarTodosLosProductos()">
                        <i class="fas fa-boxes"></i> Mostrar Todos
                    </button>
                </div>
                
                <div id="productosLista" class="productos-lista">
                    <div class="productos-empty">
                        <i class="fas fa-info-circle"></i>
                        <p style="font-size: 0.75rem;">Usa el buscador o<br>"Mostrar Todos"</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================
         PANEL CENTRAL - CARRITO PROTAGONISTA
         ============================================ -->
    <div class="carrito-panel">
        <div class="pos-card carrito-card-wrapper">
            <div class="pos-card-content carrito-content-wrapper">
                <div class="pos-card-header">
                    <h2 class="pos-card-title">
                        <i class="fas fa-shopping-cart"></i> Carrito de Venta
                        <span id="carritoCount" style="background: #3b82f6; color: white; padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.85rem; margin-left: 0.5rem;">0</span>
                    </h2>
                </div>
                
                <div id="carritoItems" class="carrito-items">
                    <div class="carrito-empty">
                        <i class="fas fa-shopping-cart"></i>
                        <h3 style="font-size: 1.2rem; margin-top: 0.8rem; font-weight: 800;">Carrito vacío</h3>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Agrega productos para iniciar la venta</p>
                    </div>
                </div>
                
                <div class="totales-container">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <strong id="subtotalDisplay">$0.00</strong>
                    </div>
                    <div class="total-row">
                        <span>Descuento:</span>
                        <strong id="descuentoDisplay" style="color: #dc2626;">-$0.00</strong>
                    </div>
                    <div class="total-row" id="ivaDisplay" style="display: none;">
                        <span>IVA:</span>
                        <strong class="summary-value" style="color: #0ea5e9;">+$0.00</strong>
                    </div>
                    <div class="total-row total-final">
                        <span>TOTAL:</span>
                        <strong id="totalDisplay">$0.00</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================
         PANEL DERECHO - OPCIONES (COMPACTO)
         ============================================ -->
    <div class="opciones-panel">
        <div class="pos-card">
            <div class="pos-card-content">
                <div class="opciones-grid">
                    <div class="opcion-item">
                        <label class="opcion-label">
                            <i class="fas fa-user"></i> Cliente
                        </label>
                        <select id="clienteSelect" class="cliente-select">
                            <option value="">Consumidor Final</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.nombres }} {{ cliente.apellidos }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="opcion-item">
                        <label class="opcion-label">
                            <i class="fas fa-file-invoice"></i> Tipo de Venta
                        </label>
                        <div class="tipo-venta-selector">
                            <button type="button" class="tipo-venta-btn active" data-tipo="CONTADO">
                                <i class="fas fa-money-bill-wave"></i> Contado
                            </button>
                            <button type="button" class="tipo-venta-btn" data-tipo="CREDITO">
                                <i class="fas fa-file-invoice-dollar"></i> Crédito
                            </button>
                        </div>
                    </div>
                    
                    <div class="opcion-item">
                        <label class="opcion-label">
                            <i class="fas fa-credit-card"></i> Método de Pago
                        </label>
                        <div class="metodo-pago-selector">
                            <button type="button" class="metodo-pago-btn active" data-metodo="EFECTIVO">
                                <i class="fas fa-money-bill"></i> Efectivo
                            </button>
                            <button type="button" class="metodo-pago-btn" data-metodo="TARJETA">
                                <i class="fas fa-credit-card"></i> Tarjeta
                            </button>
                            <button type="button" class="metodo-pago-btn" data-metodo="TRANSFERENCIA">
                                <i class="fas fa-exchange-alt"></i> Transfer.
                            </button>
                            <button type="button" class="metodo-pago-btn" data-metodo="OTRO">
                                <i class="fas fa-ellipsis-h"></i> Otro
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="pagoContainer" class="pago-container visible">
                    <div class="pago-grid">
                        <div class="pago-item">
                            <label class="pago-label">
                                <i class="fas fa-hand-holding-usd"></i> Recibido
                            </label>
                            <input type="number" 
                                   id="montoRecibido" 
                                   class="pago-input" 
                                   value="0.00"
                                   min="0"
                                   step="0.01"
                                   placeholder="0.00"
                                   oninput="calcularCambio()">
                        </div>
                        <div class="pago-item">
                            <label class="pago-label">
                                <i class="fas fa-coins"></i> Cambio
                            </label>
                            <div id="cambioBox" class="cambio-box">
                                <div class="cambio-value">$0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="acciones-container">
                    <button type="button" class="btn-limpiar" onclick="limpiarCarrito()">
                        <i class="fas fa-trash"></i> Limpiar Carrito
                    </button>
                    
                    <button type="button" id="btnProcesar" class="btn-procesar" onclick="procesarVenta()" disabled>
                        <i class="fas fa-check-circle"></i> Procesar Venta
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: VENTA EXITOSA -->
<div id="modalVentaExitosa" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fas fa-check-circle"></i>
                <h3 class="modal-title">¡Venta Procesada!</h3>
            </div>
            <div class="modal-body">
                <div class="venta-info">
                    <div class="venta-info-row">
                        <span class="venta-info-label">N° Venta:</span>
                        <span class="venta-info-value" id="modalNumeroVenta"></span>
                    </div>
                    <div class="venta-info-row">
                        <span class="venta-info-label">Total:</span>
                        <span class="venta-total" id="modalTotal"></span>
                    </div>
                    <div class="venta-info-row" id="modalCambioRow" style="display: none;">
                        <span class="venta-info-label">Cambio:</span>
                        <span class="venta-info-value" id="modalCambio"></span>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-modal-primary" onclick="imprimirTicket()">
                        <i class="fas fa-print"></i> Imprimir Ticket
                    </button>
                    <button type="button" class="btn-modal btn-modal-secondary" onclick="cerrarModalVenta()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============================================
// VARIABLES GLOBALES
// ============================================
let carrito = [];
let subtotal = 0;
let descuentoTotal = 0;
let total = 0;
let tipoVenta = 'CONTADO';
let metodoPago = 'EFECTIVO';
let ventaIdActual = null;
let montoRecibido = 0;
let cambio = 0;

// ✅ AGREGAR VARIABLE IVA (viene de Django)
const IVA_DEFAULT = parseFloat("{{ iva_porcentaje|default:'0' }}") || 0;
console.log('🧾 IVA configurado:', IVA_DEFAULT, '%');

// ============================================
// SISTEMA DE ALERTAS
// ============================================
window.mostrarAlerta = function(tipo, titulo, mensaje) {
    const iconos = {
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        success: 'fa-check-circle',
        info: 'fa-info-circle'
    };
    
    const alerta = document.createElement('div');
    alerta.className = `alert-toast ${tipo}`;
    alerta.innerHTML = `
        <i class="fas ${iconos[tipo]} alert-icon"></i>
        <div class="alert-content">
            <div class="alert-title">${titulo}</div>
            <div class="alert-message">${mensaje}</div>
        </div>
        <button class="alert-close" onclick="cerrarAlerta(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    document.body.appendChild(alerta);
    
    setTimeout(() => {
        if (alerta.parentElement) {
            cerrarAlerta(alerta.querySelector('.alert-close'));
        }
    }, 5000);
}

function cerrarAlerta(btn) {
    const alerta = btn.closest('.alert-toast');
    alerta.classList.add('hiding');
    setTimeout(() => {
        if (alerta.parentElement) {
            alerta.remove();
        }
    }, 300);
}

// ============================================
// CALCULAR CAMBIO EN TIEMPO REAL
// ============================================
function calcularCambio() {
    montoRecibido = parseFloat(document.getElementById('montoRecibido').value) || 0;
    cambio = montoRecibido - total;
    
    const cambioBox = document.getElementById('cambioBox');
    const cambioValue = cambioBox.querySelector('.cambio-value');
    
    cambioValue.textContent = `$${Math.abs(cambio).toFixed(2)}`;
    
    if (cambio < 0) {
        cambioBox.classList.add('negativo');
        cambioValue.classList.add('negativo');
    } else {
        cambioBox.classList.remove('negativo');
        cambioValue.classList.remove('negativo');
    }
    
    validarProcesarVenta();
}

// ============================================
// VALIDAR SI SE PUEDE PROCESAR LA VENTA
// ============================================
function validarProcesarVenta() {
    const btnProcesar = document.getElementById('btnProcesar');
    
    if (carrito.length === 0) {
        btnProcesar.disabled = true;
        return;
    }
    
    if (tipoVenta === 'CONTADO' && metodoPago === 'EFECTIVO') {
        btnProcesar.disabled = montoRecibido < total;
    } else {
        btnProcesar.disabled = false;
    }
}

// ============================================
// MOSTRAR/OCULTAR CAMPOS DE PAGO
// ============================================
function actualizarCamposPago() {
    const pagoContainer = document.getElementById('pagoContainer');
    
    if (tipoVenta === 'CONTADO') {
        pagoContainer.classList.add('visible');
    } else {
        pagoContainer.classList.remove('visible');
    }
}

// ============================================
// INICIALIZACIÓN
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('searchInput').addEventListener('input', debounce(buscarProductos, 300));
    document.getElementById('categoriaFilter').addEventListener('change', buscarProductos);
    
    document.querySelectorAll('.tipo-venta-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tipo-venta-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            tipoVenta = this.dataset.tipo;
            actualizarCamposPago();
            validarProcesarVenta();
        });
    });
    
    document.querySelectorAll('.metodo-pago-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.metodo-pago-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            metodoPago = this.dataset.metodo;
            validarProcesarVenta();
        });
    });
});

// ============================================
// CARGAR TODOS LOS PRODUCTOS
// ============================================
window.cargarTodosLosProductos = function() {
    document.getElementById('productosLista').innerHTML = `
        <div class="productos-empty">
            <div class="spinner" style="border-color: rgba(59, 130, 246, 0.2); border-top-color: #3b82f6; width: 24px; height: 24px;"></div>
            <p style="font-size: 0.75rem; margin-top: 0.5rem;">Cargando...</p>
        </div>
    `;

    fetch(`/panel/api/productos/buscar/?all=true`, {
        credentials: "include",
    })
        .then(response => response.json())
        .then(data => {
            console.log('📡 Productos recibidos del servidor:', data.productos);
            mostrarProductos(data.productos);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('productosLista').innerHTML = `
                <div class="productos-empty" style="color: #dc2626;">
                    <i class="fas fa-exclamation-circle"></i>
                    <p style="font-size: 0.75rem;">Error al cargar</p>
                </div>
            `;
            mostrarAlerta('error', 'Error', 'No se pudieron cargar los productos');
        });
}

// ============================================
// BUSCAR PRODUCTOS
// ============================================
function buscarProductos() {
    const query = document.getElementById('searchInput').value.trim();
    const categoria = document.getElementById('categoriaFilter').value;
    
    if (!query && !categoria) {
        document.getElementById('productosLista').innerHTML = `
            <div class="productos-empty">
                <i class="fas fa-info-circle"></i>
                <p style="font-size: 0.75rem;">Usa el buscador o<br>"Mostrar Todos"</p>
            </div>
        `;
        return;
    }
    
    document.getElementById('productosLista').innerHTML = `
        <div class="productos-empty">
            <div class="spinner" style="border-color: rgba(59, 130, 246, 0.2); border-top-color: #3b82f6; width: 24px; height: 24px;"></div>
            <p style="font-size: 0.75rem; margin-top: 0.5rem;">Buscando...</p>
        </div>
    `;
    
    const params = new URLSearchParams();
    if (query) params.append('q', query);
    if (categoria) params.append('categoria', categoria);

    fetch(`/panel/api/productos/buscar/?${params.toString()}`, {
        credentials: "include",
    })
        .then(response => response.json())
        .then(data => {
            console.log('📡 Productos encontrados:', data.productos);
            mostrarProductos(data.productos);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('productosLista').innerHTML = `
                <div class="productos-empty" style="color: #dc2626;">
                    <i class="fas fa-exclamation-circle"></i>
                    <p style="font-size: 0.75rem;">Error al buscar</p>
                </div>
            `;
            mostrarAlerta('error', 'Error', 'No se pudo realizar la búsqueda');
        });
}

// ============================================
// ✅ MOSTRAR PRODUCTOS - CORREGIDO
// ============================================
window.mostrarProductos = function(productos) {
    const lista = document.getElementById('productosLista');
    
    if (productos.length === 0) {
        lista.innerHTML = `
            <div class="productos-empty">
                <i class="fas fa-box-open"></i>
                <p style="font-size: 0.75rem;">No se encontraron productos</p>
            </div>
        `;
        return;
    }
    
    lista.innerHTML = productos.map(producto => {
        const stock = producto.stock_actual || 0;
        let stockBadge = '';
        let itemClass = '';
        
        if (stock === 0) {
            stockBadge = '<span class="stock-badge agotado"><i class="fas fa-times-circle"></i> AGOTADO</span>';
            itemClass = 'sin-stock';
        } else if (stock < 10 && producto.tipo_inventario === 'NORMAL') {
            stockBadge = `<span class="stock-badge bajo"><i class="fas fa-exclamation-triangle"></i> ${stock}</span>`;
        } else if (producto.tipo_inventario === 'NORMAL') {
            stockBadge = `<span class="stock-badge disponible"><i class="fas fa-check-circle"></i> ${stock}</span>`;
        } else if (producto.tipo_inventario === 'QUINTAL') {
            stockBadge = `<span class="stock-badge disponible"><i class="fas fa-weight"></i> ${stock.toFixed(2)}kg</span>`;
        }
        
        // ✅ CORRECCIÓN CRÍTICA: Obtener precio con todos los fallbacks posibles
        const precio = parseFloat(
            producto.precio || 
            producto.precio_unitario || 
            producto.precio_venta || 
            producto.precio_por_unidad_peso || 
            0
        );
        
        // ✅ DEBUG: Mostrar información completa del producto
        console.log('📦 Renderizando:', {
            nombre: producto.nombre,
            precio_usado: precio,
            campos_disponibles: {
                precio: producto.precio,
                precio_unitario: producto.precio_unitario,
                precio_venta: producto.precio_venta,
                precio_por_unidad_peso: producto.precio_por_unidad_peso
            }
        });
        
        if (precio === 0) {
            console.warn('⚠️ Producto sin precio válido:', producto);
        }
        
        // ✅ SOLUCIÓN: Codificar producto en Base64 para evitar problemas con comillas
        const productoJSON = JSON.stringify(producto);
        const productoEncoded = btoa(encodeURIComponent(productoJSON));
        const onclick = stock > 0 ? `onclick='agregarProductoPorData(this)'` : '';
        
        return `
            <div class="producto-item ${itemClass}" 
                 ${onclick}
                 data-producto='${productoEncoded}'>
                <div class="producto-info">
                    <div class="producto-nombre">${producto.nombre}</div>
                    <div class="producto-codigo">
                        <i class="fas fa-barcode"></i> ${producto.codigo_barras || 'Sin código'}
                        ${stockBadge}
                    </div>
                </div>
                <div class="producto-precio">$${precio.toFixed(2)}</div>
            </div>
        `;
    }).join('');
}

// ============================================
// ✅ NUEVA FUNCIÓN: DECODIFICAR Y AGREGAR PRODUCTO
// ============================================
window.agregarProductoPorData = function(elemento) {
    try {
        const productoEncoded = elemento.getAttribute('data-producto');
        const productoJSON = decodeURIComponent(atob(productoEncoded));
        const producto = JSON.parse(productoJSON);
        
        console.log('🎯 Producto decodificado:', producto);
        agregarAlCarrito(producto);
    } catch (error) {
        console.error('❌ Error al decodificar producto:', error);
        mostrarAlerta('error', 'Error', 'No se pudo agregar el producto al carrito');
    }
}

// ============================================
// ✅ AGREGAR AL CARRITO - CORREGIDO
// ============================================
window.agregarAlCarrito = function(producto) {
    // Verificar si es un quintal
    if (producto.tipo_inventario === 'QUINTAL') {
        window.mostrarModalQuintales(producto);
        return;
    }
    
    const stockDisponible = producto.stock_actual || 0;
    
    if (stockDisponible <= 0) {
        mostrarAlerta('error', '❌ Sin Stock', `No hay stock disponible de ${producto.nombre}`);
        return;
    }
    
    const itemExistente = carrito.find(item => item.producto_id === producto.id);
    
    if (itemExistente) {
        const nuevaCantidad = itemExistente.cantidad + 1;
        
        if (nuevaCantidad > stockDisponible) {
            mostrarAlerta('warning', '⚠️ Stock Insuficiente', 
                `Solo hay ${stockDisponible} ${producto.tipo_inventario === 'QUINTAL' ? 'kg' : 'unidades'} disponibles de ${producto.nombre}`);
            return;
        }
        
        itemExistente.cantidad = nuevaCantidad;
        itemExistente.subtotal = itemExistente.cantidad * itemExistente.precio;
        itemExistente.total = itemExistente.subtotal - itemExistente.descuento;
        mostrarAlerta('info', '✓ Cantidad Actualizada', `${producto.nombre} x ${nuevaCantidad}`);
    } else {
        // ✅ CORRECCIÓN CRÍTICA: Obtener precio con fallbacks y parseFloat
        const precio = parseFloat(
            producto.precio || 
            producto.precio_unitario || 
            producto.precio_venta || 
            producto.precio_por_unidad_peso || 
            0
        );
        
        // ✅ DEBUG DETALLADO
        console.log('➕ Agregando al carrito:', {
            nombre: producto.nombre,
            precio_final: precio,
            todos_los_campos: producto
        });
        
        // ✅ VALIDACIÓN: No agregar productos sin precio
        if (precio === 0 || isNaN(precio)) {
            console.error('❌ PRECIO INVÁLIDO:', producto);
            mostrarAlerta('error', '❌ Error de Precio', 
                `${producto.nombre} no tiene un precio válido configurado`);
            return;
        }
        
        carrito.push({
            producto_id: producto.id,
            nombre: producto.nombre,
            codigo: producto.codigo_barras || 'Sin código',
            tipo_inventario: producto.tipo_inventario || 'NORMAL',
            unidad_medida: producto.unidad_medida || 'und',
            precio: precio,
            cantidad: 1,
            stock_disponible: stockDisponible,
            descuento_porcentaje: 0,
            descuento: 0,
            subtotal: precio,
            total: precio,
        });
        
        mostrarAlerta('success', '✓ Producto Agregado', `${producto.nombre} agregado al carrito`);
    }
    
    actualizarCarrito();
}

// ============================================
// GESTIÓN DEL CARRITO
// ============================================
function eliminarDelCarrito(index) {
    const item = carrito[index];
    carrito.splice(index, 1);
    mostrarAlerta('info', 'Producto Eliminado', `${item.nombre} eliminado del carrito`);
    actualizarCarrito();
}

function cambiarCantidad(index, delta) {
    const item = carrito[index];
    const nuevaCantidad = item.cantidad + delta;
    
    if (nuevaCantidad > item.stock_disponible) {
        mostrarAlerta('warning', '⚠️ Stock Insuficiente', 
            `Solo hay ${item.stock_disponible} ${item.tipo_inventario === 'QUINTAL' ? 'kg' : 'unidades'} disponibles`);
        return;
    }
    
    if (nuevaCantidad >= 0.001) {
        item.cantidad = nuevaCantidad;
        item.subtotal = item.cantidad * item.precio;
        item.total = item.subtotal - item.descuento;
        actualizarCarrito();
    }
}

function actualizarCantidadDirecta(index, valor) {
    const item = carrito[index];
    const cantidad = parseFloat(valor) || 0.001;
    
    if (cantidad > item.stock_disponible) {
        mostrarAlerta('warning', '⚠️ Stock Insuficiente', 
            `Solo hay ${item.stock_disponible} ${item.tipo_inventario === 'QUINTAL' ? 'kg' : 'unidades'} disponibles de ${item.nombre}`);
        document.querySelector(`#carritoItems .carrito-item:nth-child(${index + 1}) .cantidad-input`).value = item.stock_disponible;
        item.cantidad = item.stock_disponible;
    } else {
        item.cantidad = Math.max(0.001, cantidad);
    }
    
    item.subtotal = item.cantidad * item.precio;
    item.total = item.subtotal - item.descuento;
    actualizarCarrito();
}

function actualizarPrecio(index, valor) {
    const item = carrito[index];
    const precio = parseFloat(valor) || 0;
    item.precio = Math.max(0, precio);
    item.subtotal = item.cantidad * item.precio;
    item.total = item.subtotal - item.descuento;
    actualizarCarrito();
}

function actualizarDescuento(index, valor) {
    const item = carrito[index];
    const descuento = parseFloat(valor) || 0;
    item.descuento = Math.max(0, Math.min(descuento, item.subtotal));
    item.descuento_porcentaje = (item.descuento / item.subtotal) * 100;
    item.total = item.subtotal - item.descuento;
    actualizarCarrito();
}

// ============================================
// ✅ ACTUALIZAR CARRITO - CON IVA CORREGIDO
// ============================================
window.actualizarCarrito = function() {
    const container = document.getElementById('carritoItems');
    
    if (carrito.length === 0) {
        container.innerHTML = `
            <div class="carrito-empty">
                <i class="fas fa-shopping-cart"></i>
                <h3 style="font-size: 1.2rem; margin-top: 0.8rem; font-weight: 800;">Carrito vacío</h3>
                <p style="font-size: 0.9rem; margin-top: 0.5rem;">Agrega productos para iniciar la venta</p>
            </div>
        `;
    } else {
        container.innerHTML = carrito.map((item, index) => `
            <div class="carrito-item">
                <div class="carrito-item-header">
                    <div class="carrito-item-info">
                        <div class="carrito-item-nombre">${item.nombre}</div>
                        <div class="carrito-item-codigo">
                            <i class="fas fa-barcode"></i> ${item.codigo}
                            <span class="carrito-item-unidad">${item.unidad_medida}</span>
                            <span class="stock-badge disponible" style="font-size: 0.65rem;">
                                <i class="fas fa-box"></i> Stock: ${item.stock_disponible}
                            </span>
                        </div>
                    </div>
                    <button type="button" class="carrito-item-eliminar" onclick="eliminarDelCarrito(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="carrito-item-grid">
                    <div class="carrito-field">
                        <label class="carrito-field-label">
                            <i class="fas fa-cubes"></i> Cantidad
                        </label>
                        <div class="cantidad-control">
                            <button type="button" class="cantidad-btn" onclick="cambiarCantidad(${index}, -1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" 
                                   class="cantidad-input" 
                                   value="${item.cantidad}" 
                                   min="0.001"
                                   max="${item.stock_disponible}"
                                   step="${item.tipo_inventario === 'QUINTAL' ? '0.001' : '1'}"
                                   onchange="actualizarCantidadDirecta(${index}, this.value)">
                            <button type="button" class="cantidad-btn" onclick="cambiarCantidad(${index}, 1)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="carrito-field">
                        <label class="carrito-field-label">
                            <i class="fas fa-dollar-sign"></i> Precio Unit.
                        </label>
                        <input type="number" 
                               class="carrito-field-input" 
                               value="${item.precio.toFixed(2)}" 
                               min="0"
                               step="0.01"
                               onchange="actualizarPrecio(${index}, this.value)">
                    </div>
                    
                    <div class="carrito-field">
                        <label class="carrito-field-label">
                            <i class="fas fa-percentage"></i> Descuento ($)
                        </label>
                        <input type="number" 
                               class="carrito-field-input" 
                               value="${item.descuento.toFixed(2)}" 
                               min="0"
                               max="${item.subtotal.toFixed(2)}"
                               step="0.01"
                               onchange="actualizarDescuento(${index}, this.value)">
                    </div>
                    
                    <div class="carrito-field">
                        <label class="carrito-field-label">
                            <i class="fas fa-calculator"></i> Subtotal
                        </label>
                        <input type="text" 
                               class="carrito-field-input" 
                               value="$${item.subtotal.toFixed(2)}" 
                               readonly
                               style="background: rgba(248, 250, 252, 0.7); cursor: not-allowed;">
                    </div>
                </div>
                
                <div class="carrito-item-footer">
                    <div class="item-total-info">
                        <span>
                            <span class="item-total-info-label">Subtotal</span>
                            <span class="item-total-info-value">$${item.subtotal.toFixed(2)}</span>
                        </span>
                        <span>
                            <span class="item-total-info-label">Desc.</span>
                            <span class="item-total-info-value descuento">-$${item.descuento.toFixed(2)}</span>
                        </span>
                    </div>
                    <div class="item-total-final">
                        <div class="item-total-final-label">TOTAL</div>
                        <div class="item-total-final-value">$${item.total.toFixed(2)}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // ✅ CÁLCULO DE TOTALES CON IVA
    subtotal = carrito.reduce((sum, item) => sum + item.subtotal, 0);
    descuentoTotal = carrito.reduce((sum, item) => sum + item.descuento, 0);
    
    // Subtotal después de descuentos
    let subtotalConDescuento = subtotal - descuentoTotal;
    
    // Calcular IVA
    let ivaCalculado = 0;
    if (IVA_DEFAULT > 0) {
        ivaCalculado = subtotalConDescuento * (IVA_DEFAULT / 100);
    }
    
    // Total final con IVA
    total = subtotalConDescuento + ivaCalculado;
    
    // ✅ DEBUG: Ver cálculos
    console.log('💰 Cálculos:', {
        subtotal: subtotal.toFixed(2),
        descuento: descuentoTotal.toFixed(2),
        subtotal_con_desc: subtotalConDescuento.toFixed(2),
        iva_porcentaje: IVA_DEFAULT,
        iva_monto: ivaCalculado.toFixed(2),
        total_final: total.toFixed(2)
    });
    
    // Actualizar displays
    document.getElementById('carritoCount').textContent = carrito.length;
    document.getElementById('subtotalDisplay').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('descuentoDisplay').textContent = `-$${descuentoTotal.toFixed(2)}`;
    
    // Mostrar IVA si existe
    const ivaDisplay = document.getElementById('ivaDisplay');
    if (ivaDisplay) {
        if (IVA_DEFAULT > 0) {
            ivaDisplay.style.display = 'flex';
            const ivaValue = ivaDisplay.querySelector('.summary-value');
            if (ivaValue) {
                ivaValue.textContent = `+$${ivaCalculado.toFixed(2)}`;
            }
        } else {
            ivaDisplay.style.display = 'none';
        }
    }
    
    document.getElementById('totalDisplay').textContent = `$${total.toFixed(2)}`;
    
    actualizarCamposPago();
    calcularCambio();
    validarProcesarVenta();
}

function limpiarCarrito() {
    if (carrito.length === 0) return;
    
    if (confirm('¿Deseas limpiar el carrito?')) {
        carrito = [];
        
        const inputMontoRecibido = document.getElementById('montoRecibido');
        inputMontoRecibido.removeAttribute('disabled');
        inputMontoRecibido.removeAttribute('readonly');
        inputMontoRecibido.value = '0.00';
        
        montoRecibido = 0;
        cambio = 0;
        
        calcularCambio();
        actualizarCarrito();
        mostrarAlerta('info', 'Carrito Limpiado', 'El carrito ha sido vaciado');
    }
}

// ============================================
// PROCESAR VENTA
// ============================================
function procesarVenta() {
    if (carrito.length === 0) {
        mostrarAlerta('warning', 'Carrito Vacío', 'Agrega productos antes de procesar la venta');
        return;
    }
    
    if (tipoVenta === 'CONTADO' && metodoPago === 'EFECTIVO' && montoRecibido < total) {
        mostrarAlerta('error', 'Monto Insuficiente', 'El monto recibido debe ser mayor o igual al total de la venta');
        return;
    }
    
    const btnProcesar = document.getElementById('btnProcesar');
    btnProcesar.disabled = true;
    btnProcesar.innerHTML = '<div class="spinner"></div> Procesando...';
    
    const data = {
        items: carrito,
        cliente_id: document.getElementById('clienteSelect').value || null,
        tipo_venta: tipoVenta,
        metodo_pago: metodoPago,
        monto_recibido: montoRecibido,
    };
    
    fetch('/panel/api/ventas/procesar/', {
        method: 'POST',
        credentials: "include",
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(data),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            ventaIdActual = data.venta_id;
            mostrarModalVentaExitosa(data);
            
            actualizarStockDespuesDeVenta();
            
            carrito = [];
            
            const inputMontoRecibido = document.getElementById('montoRecibido');
            inputMontoRecibido.removeAttribute('disabled');
            inputMontoRecibido.removeAttribute('readonly');
            inputMontoRecibido.value = '0.00';
            
            montoRecibido = 0;
            cambio = 0;
            
            calcularCambio();
            actualizarCarrito();
            mostrarAlerta('success', '✓ Venta Exitosa', `Venta ${data.numero_venta} procesada correctamente`);
        } else {
            mostrarAlerta('error', 'Error en la Venta', data.error || 'No se pudo procesar la venta');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarAlerta('error', 'Error', 'No se pudo conectar con el servidor');
    })
    .finally(() => {
        btnProcesar.disabled = false;
        btnProcesar.innerHTML = '<i class="fas fa-check-circle"></i> Procesar Venta';
    });
}

function actualizarStockDespuesDeVenta() {
    const productosLista = document.getElementById('productosLista');
    
    if (productosLista.querySelector('.productos-empty') && 
        productosLista.textContent.includes('Usa el buscador')) {
        return;
    }
    
    const searchInput = document.getElementById('searchInput').value.trim();
    const categoriaFilter = document.getElementById('categoriaFilter').value;
    
    if (searchInput || categoriaFilter) {
        buscarProductos();
    } else {
        const tieneProductos = productosLista.querySelectorAll('.producto-item').length > 0;
        if (tieneProductos) {
            cargarTodosLosProductos();
        }
    }
}

function mostrarModalVentaExitosa(data) {
    document.getElementById('modalNumeroVenta').textContent = data.numero_venta;
    document.getElementById('modalTotal').textContent = `$${data.total.toFixed(2)}`;
    
    if (data.cambio && data.cambio > 0) {
        document.getElementById('modalCambioRow').style.display = 'flex';
        document.getElementById('modalCambio').textContent = `$${data.cambio.toFixed(2)}`;
    } else {
        document.getElementById('modalCambioRow').style.display = 'none';
    }
    
    document.getElementById('modalVentaExitosa').classList.add('show');
}

function cerrarModalVenta() {
    document.getElementById('modalVentaExitosa').classList.remove('show');
    ventaIdActual = null;
    
    const inputMontoRecibido = document.getElementById('montoRecibido');
    inputMontoRecibido.removeAttribute('disabled');
    inputMontoRecibido.removeAttribute('readonly');
    inputMontoRecibido.value = '0.00';
    
    montoRecibido = 0;
    cambio = 0;
    calcularCambio();
}

// ============================================
// IMPRIMIR TICKET
// ============================================
function imprimirTicket() {
    if (!ventaIdActual) {
        mostrarAlerta('error', 'Error', 'No hay venta para imprimir');
        return;
    }
    
    const btnImprimir = document.querySelector('#modalVentaExitosa .btn-modal-primary');
    let textoOriginal = '';
    
    if (btnImprimir) {
        textoOriginal = btnImprimir.innerHTML;
        btnImprimir.disabled = true;
        btnImprimir.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando a impresora...';
    }
    
    fetch(`/panel/api/ventas/${ventaIdActual}/reimprimir-ticket/`, {
        method: 'POST',
        credentials: "include",
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
            abrir_gaveta: false
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            mostrarAlerta('success', '🖨️ Ticket Enviado', 
                data.mensaje || 'Ticket enviado a la impresora');
            
            setTimeout(() => {
                cerrarModalVenta();
            }, 2000);
        } else {
            mostrarAlerta('error', '❌ Error al Imprimir', 
                data.error || 'No se pudo crear el trabajo de impresión');
        }
    })
    .catch(error => {
        console.error('❌ Error imprimiendo ticket:', error);
        mostrarAlerta('error', '❌ Error de Conexión', 
            'No se pudo conectar con el servidor');
    })
    .finally(() => {
        if (btnImprimir) {
            btnImprimir.disabled = false;
            btnImprimir.innerHTML = textoOriginal || '<i class="fas fa-print"></i> Imprimir Ticket';
        }
    });
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

window.onclick = function(event) {
    const modal = document.getElementById('modalVentaExitosa');
    if (event.target === modal) {
        cerrarModalVenta();
    }
}

// ========================================
// FUNCIONES PARA MANEJO DE QUINTALES
// ========================================
window.mostrarModalQuintales = function(producto) {
    if (producto.tipo_inventario !== 'QUINTAL') {
        agregarAlCarrito(producto);
        return;
    }
    
    fetch(`/panel/api/productos/${producto.id}/quintales/`)
        .then(response => response.json())
        .then(data => {
            console.log('📦 Quintales recibidos:', data);
            
            if (!data.success || !data.quintales || data.quintales.length === 0) {
                alert('No hay quintales disponibles para este producto');
                return;
            }
            
            let modalHtml = `
                <div class="modal fade" id="modalQuintalVenta" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Vender ${producto.nombre} (Quintal)</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label>Seleccione Quintal:</label>
                                    <select id="quintalSelect" class="form-control">
                                        ${data.quintales.map(q => 
                                            `<option value="${q.id}" 
                                                     data-peso="${q.peso_actual}" 
                                                     data-precio="${q.costo_por_unidad}" 
                                                     data-unidad="${q.unidad_medida}" 
                                                     data-codigo="${q.codigo_unico}">
                                                ${q.codigo_unico} - ${q.peso_actual} ${q.unidad_medida} disponibles - $${q.costo_por_unidad}/${q.unidad_medida}
                                            </option>`
                                        ).join('')}
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label>Tipo de venta:</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="tipoVenta" id="ventaPeso" value="peso" checked>
                                        <label class="btn btn-outline-primary" for="ventaPeso">Por Peso</label>
                                        
                                        <input type="radio" class="btn-check" name="tipoVenta" id="ventaDinero" value="dinero">
                                        <label class="btn btn-outline-primary" for="ventaDinero">Por Dinero</label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label id="labelCantidad">Cantidad en peso:</label>
                                    <input type="number" id="cantidadQuintal" class="form-control" step="0.01" min="0.01">
                                    <small id="helpText" class="form-text text-muted"></small>
                                </div>
                                
                                <div class="alert alert-info">
                                    <strong>Resumen:</strong>
                                    <div id="resumenVenta">Seleccione cantidad</div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" onclick="confirmarVentaQuintal('${producto.id}', '${producto.nombre}')">
                                    Agregar al Carrito
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            let oldModal = document.getElementById('modalQuintalVenta');
            if (oldModal) {
                oldModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            document.getElementById('ventaPeso').addEventListener('change', () => {
                document.getElementById('labelCantidad').innerText = 'Cantidad en peso:';
                actualizarResumenQuintal();
            });
            
            document.getElementById('ventaDinero').addEventListener('change', () => {
                document.getElementById('labelCantidad').innerText = 'Cantidad en dinero ($):';
                actualizarResumenQuintal();
            });
            
            document.getElementById('cantidadQuintal').addEventListener('input', actualizarResumenQuintal);
            document.getElementById('quintalSelect').addEventListener('change', actualizarResumenQuintal);
            
            let modal = new bootstrap.Modal(document.getElementById('modalQuintalVenta'));
            modal.show();
        })
        .catch(error => {
            console.error('❌ Error cargando quintales:', error);
            alert('Error al cargar quintales: ' + error.message);
        });
}

function actualizarResumenQuintal() {
    const quintalSelect = document.getElementById('quintalSelect');
    const selectedOption = quintalSelect.options[quintalSelect.selectedIndex];
    const cantidad = parseFloat(document.getElementById('cantidadQuintal').value) || 0;
    const tipoVenta = document.querySelector('input[name="tipoVenta"]:checked').value;
    
    if (cantidad <= 0) {
        document.getElementById('resumenVenta').innerHTML = 'Ingrese una cantidad';
        return;
    }
    
    const pesoDisponible = parseFloat(selectedOption.dataset.peso);
    const precioPorUnidad = parseFloat(selectedOption.dataset.precio);
    const unidad = selectedOption.dataset.unidad;
    
    if (tipoVenta === 'peso') {
        if (cantidad > pesoDisponible) {
            document.getElementById('resumenVenta').innerHTML = 
                `<span class="text-danger">Excede disponible (máx: ${pesoDisponible} ${unidad})</span>`;
        } else {
            const total = cantidad * precioPorUnidad;
            document.getElementById('resumenVenta').innerHTML = 
                `${cantidad} ${unidad} = $${total.toFixed(2)}`;
        }
    } else {
        const pesoCalculado = cantidad / precioPorUnidad;
        if (pesoCalculado > pesoDisponible) {
            document.getElementById('resumenVenta').innerHTML = 
                `<span class="text-danger">$${cantidad} excede disponible (máx: $${(pesoDisponible * precioPorUnidad).toFixed(2)})</span>`;
        } else {
            document.getElementById('resumenVenta').innerHTML = 
                `$${cantidad} = ${pesoCalculado.toFixed(3)} ${unidad}`;
        }
    }
}

function confirmarVentaQuintal(productoId, productoNombre) {
    const quintalId = document.getElementById('quintalSelect').value;
    const cantidad = parseFloat(document.getElementById('cantidadQuintal').value);
    const tipoVenta = document.querySelector('input[name="tipoVenta"]:checked').value;
    
    if (!cantidad || cantidad <= 0) {
        alert('Ingrese una cantidad válida');
        return;
    }
    
    const quintalSelect = document.getElementById('quintalSelect');
    const selectedOption = quintalSelect.options[quintalSelect.selectedIndex];
    const precioPorUnidad = parseFloat(selectedOption.dataset.precio);
    const unidad = selectedOption.dataset.unidad;
    
    let pesoVenta, precioTotal;
    
    if (tipoVenta === 'peso') {
        pesoVenta = cantidad;
        precioTotal = cantidad * precioPorUnidad;
    } else {
        pesoVenta = cantidad / precioPorUnidad;
        precioTotal = cantidad;
    }
    
    carrito.push({
        producto_id: productoId,
        nombre: `${productoNombre} (${pesoVenta.toFixed(3)} ${unidad})`,
        precio: precioTotal,
        cantidad: 1,
        es_quintal: true,
        quintal_id: quintalId,
        peso_vendido: pesoVenta,
        codigo: selectedOption.dataset.codigo || "QUINTAL",
        stock_disponible: parseFloat(selectedOption.dataset.peso) || 100,
        subtotal: precioTotal,
        total: precioTotal,
        descuento: 0,
        descuento_porcentaje: 0
    });
    
    actualizarCarrito();
    
    bootstrap.Modal.getInstance(document.getElementById('modalQuintalVenta')).hide();
    
    mostrarAlerta('success', '✓ Quintal Agregado', 
        `${pesoVenta.toFixed(3)} ${unidad} de ${productoNombre} por $${precioTotal.toFixed(2)}`);
}
</script>
{% endblock %}