{% extends 'custom_admin/base_admin.html' %}
{% load static %}

{% block title %}Entrada de Inventario Unificada{% endblock %}

{% block extra_css %}
<style>
    .main-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    /* TARJETA DE FORMULARIO */
    .form-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        padding: 2rem;
        margin-bottom: 2rem;
        border: 2px solid rgba(59, 130, 246, 0.2);
    }

    .form-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(59, 130, 246, 0.1);
    }

    .form-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .form-header-icon {
        font-size: 2.5rem;
    }

    .form-header-title h2 {
        margin: 0;
        color: #1e40af;
        font-weight: 700;
    }

    .form-header-title p {
        margin: 0;
        color: #64748b;
        font-size: 0.9rem;
    }

    /* BADGE CONTADOR */
    .badge-counter {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .badge-counter:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    .badge-counter-number {
        background: white;
        color: #1e40af;
        padding: 0.25rem 0.75rem;
        border-radius: 8px;
        font-size: 1.2rem;
        font-weight: 700;
    }

    /* CAMPOS DEL FORMULARIO */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label-custom {
        font-weight: 600;
        color: #334155;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-label-custom .required {
        color: #ef4444;
        font-weight: 700;
    }

    .form-input {
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-input.error {
        border-color: #ef4444;
    }

    .form-input:disabled {
        background: #f8fafc;
        color: #94a3b8;
        cursor: not-allowed;
    }

    /* PREVIEW DE IMAGEN */
    .image-preview-container {
        margin-top: 1rem;
        display: none;
        position: relative;
    }

    .image-preview-container.show {
        display: block;
    }

    .image-preview {
        max-width: 100%;
        max-height: 200px;
        border-radius: 12px;
        border: 3px solid #e2e8f0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        display: block;
        margin: 0 auto;
    }

    .image-preview-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    /* BOTONES DE ACCI√ìN */
    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding-top: 1.5rem;
        border-top: 2px solid rgba(59, 130, 246, 0.1);
    }

    .btn-custom {
        padding: 0.875rem 2rem;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary-custom {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary-custom {
        background: #f1f5f9;
        color: #475569;
    }

    .btn-secondary-custom:hover {
        background: #e2e8f0;
    }

    .btn-success-custom {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-success-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }

    .btn-danger-custom {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-danger-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }

    .btn-warning-custom {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .btn-warning-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
    }

    /* MODAL PERSONALIZADO */
    .modal-custom {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    }

    .modal-custom.show {
        display: flex;
    }

    .modal-content-custom {
        background: white;
        border-radius: 16px;
        padding: 0;
        max-width: 95%;
        width: 1400px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: scaleIn 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    @keyframes scaleIn {
        from {
            transform: scale(0.9);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .modal-header-custom {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header-custom h3 {
        margin: 0;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .btn-close-modal {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .btn-close-modal:hover {
        background: rgba(255,255,255,0.3);
    }

    .modal-body-custom {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
    }

    .modal-footer-custom {
        padding: 1.5rem 2rem;
        border-top: 2px solid #e2e8f0;
        background: #f8fafc;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* TABLA DE PRODUCTOS */
    .table-custom {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .table-custom thead {
        background: #f8fafc;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .table-custom th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #475569;
        border-bottom: 2px solid #e2e8f0;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
    }

    .table-custom td {
        padding: 1rem;
        border-bottom: 1px solid #f1f5f9;
        color: #334155;
    }

    .table-custom tbody tr {
        transition: background 0.2s ease;
    }

    .table-custom tbody tr:hover {
        background: #f8fafc;
    }

    .product-name {
        font-weight: 600;
        color: #1e293b;
    }

    .product-details {
        font-size: 0.85rem;
        color: #64748b;
        margin-top: 0.25rem;
    }

    .product-image-small {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #e2e8f0;
    }

    .badge-custom {
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .badge-info {
        background: #dbeafe;
        color: #1e40af;
    }

    .badge-success {
        background: #d1fae5;
        color: #065f46;
    }

    /* BOTONES DE TABLA */
    .btn-table {
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        margin: 0 0.25rem;
        font-size: 0.85rem;
    }

    .btn-edit {
        background: rgba(59, 130, 246, 0.1);
        color: #2563eb;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .btn-edit:hover {
        background: #3b82f6;
        color: white;
        transform: scale(1.05);
    }

    .btn-delete {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .btn-delete:hover {
        background: #ef4444;
        color: white;
        transform: scale(1.05);
    }

    /* ESTADO VAC√çO */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
    }

    .empty-state-icon {
        font-size: 5rem;
        opacity: 0.3;
        margin-bottom: 1rem;
    }

    .empty-state h3 {
        color: #64748b;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #94a3b8;
    }

    /* INPUT DE C√ìDIGOS EN TABLA */
    .input-codigos-tabla {
        width: 80px;
        padding: 0.5rem;
        border: 2px solid #f59e0b;
        border-radius: 6px;
        text-align: center;
        font-weight: 700;
        font-size: 1rem;
        background: linear-gradient(135deg, #fef3c7, #fde68a);
    }

    .input-codigos-tabla:focus {
        outline: none;
        border-color: #d97706;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }

    /* NOTIFICACIONES */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        background: white;
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        z-index: 99999;
        animation: slideInRight 0.3s ease;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .notification.success {
        border-left: 4px solid #10b981;
    }

    .notification.error {
        border-left: 4px solid #ef4444;
    }

    .notification-icon {
        font-size: 1.5rem;
    }

    .notification-content strong {
        display: block;
        margin-bottom: 0.25rem;
    }

    /* ALERTA DE INFORMACI√ìN */
    .info-alert {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        border: 2px solid #3b82f6;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .info-alert-content {
        display: flex;
        align-items: start;
        gap: 1rem;
    }

    .info-alert-icon {
        font-size: 2rem;
    }

    .info-alert h4 {
        margin: 0 0 0.5rem 0;
        color: #1e40af;
        font-size: 1.1rem;
    }

    .info-alert p {
        margin: 0;
        color: #1e40af;
        line-height: 1.6;
    }

    /* TOTAL DISPLAY */
    .total-summary {
        display: flex;
        align-items: center;
        gap: 2rem;
    }

    .total-item {
        display: flex;
        flex-direction: column;
    }

    .total-label {
        font-size: 0.85rem;
        color: #64748b;
        text-transform: uppercase;
        font-weight: 600;
    }

    .total-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
    }

    .total-value.highlight {
        color: #f59e0b;
    }

    @keyframes fadeOut {
        to {
            opacity: 0;
            transform: translateX(100px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- HEADER -->
    <div style="margin-bottom: 2rem;">
        <h1 style="font-size: 2.5rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">
            üì¶ Entrada de Inventario Unificada
        </h1>
        <p style="color: #64748b; font-size: 1.1rem;">
            Registra productos nuevos con imagen, marca y genera c√≥digos de barras personalizados
        </p>
    </div>

    <!-- FORMULARIO DE AGREGAR PRODUCTO -->
    <div class="form-card">
        <div class="form-header">
            <div class="form-header-left">
                <div class="form-header-icon">‚ûï</div>
                <div class="form-header-title">
                    <h2>Agregar Producto al Inventario</h2>
                    <p>Completa toda la informaci√≥n del producto incluyendo su imagen</p>
                </div>
            </div>
            <div class="badge-counter" onclick="abrirModalProductos()" title="Ver productos agregados">
                <span>üì¶ Productos:</span>
                <span class="badge-counter-number" id="contador-productos">0</span>
            </div>
        </div>

        <form id="form-producto" onsubmit="event.preventDefault(); agregarProducto();">
            <div class="form-grid">
                <!-- ALERTA INFORMATIVA -->
                <div style="grid-column: 1 / -1; background: linear-gradient(135deg, #d1fae5, #a7f3d0); border: 2px solid #10b981; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: start; gap: 1rem;">
                        <div style="font-size: 2rem;">üí∞</div>
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; color: #065f46; font-size: 1.1rem;">C√°lculo Autom√°tico de Precio</h4>
                            <p style="margin: 0; color: #065f46; line-height: 1.6;">
                                <strong>El precio de venta se calcula autom√°ticamente</strong> seg√∫n el margen de ganancia de la categor√≠a.<br>
                                üìä Ejemplo: Si el costo es $10 y la categor√≠a tiene 30% de ganancia ‚Üí Precio: $13.00<br>
                                ‚úÖ Solo ingresa el <strong>costo unitario</strong> y selecciona la <strong>categor√≠a</strong>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- IMAGEN DEL PRODUCTO -->
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label-custom">
                        <span>üì∑ Imagen del Producto</span>
                    </label>
                    <input 
                        type="file" 
                        id="input_imagen" 
                        class="form-input" 
                        accept="image/*"
                        onchange="previsualizarImagen(this)"
                    >
                    <div id="preview-imagen-container" class="image-preview-container">
                        <img id="preview-imagen" class="image-preview" alt="Preview">
                        <span class="image-preview-badge">‚úì Imagen Cargada</span>
                    </div>
                </div>

                <!-- NOMBRE DEL PRODUCTO -->
                <div class="form-group">
                    <label class="form-label-custom">
                        <span>Nombre del Producto</span>
                        <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="input_nombre" 
                        class="form-input" 
                        placeholder="Ej: Arroz Premium"
                        required
                    >
                </div>

                <!-- MARCA -->
                <div class="form-group">
                    <label class="form-label-custom">
                        <span>Marca</span>
                        <span class="required">*</span>
                    </label>
                    <select id="input_marca" class="form-input" required>
                        <option value="">Seleccione una marca</option>
                        {% for marca in marcas %}
                        <option value="{{ marca.id }}">{{ marca.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- CATEGOR√çA -->
                <div class="form-group">
                    <label class="form-label-custom">
                        <span>Categor√≠a</span>
                        <span class="required">*</span>
                    </label>
                    <select id="input_categoria" class="form-input" required onchange="calcularPrecioVenta()">
                        <option value="">Seleccione una categor√≠a</option>
                        {% for categoria in categorias %}
                        <option value="{{ categoria.id }}">{{ categoria.nombre }} ({{ categoria.margen_ganancia_sugerido }}% ganancia)</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- PROVEEDOR -->
                <div class="form-group">
                    <label class="form-label-custom">
                        <span>Proveedor</span>
                        <span class="required">*</span>
                    </label>
                    <select id="input_proveedor" class="form-input" required>
                        <option value="">Seleccione un proveedor</option>
                        {% for proveedor in proveedores %}
                        <option value="{{ proveedor.id }}">{{ proveedor.nombre_comercial }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- TIPO DE INVENTARIO -->
                <div class="form-group">
                    <label class="form-label-custom">
                        <span>üì¶ Tipo de Inventario</span>
                        <span class="required">*</span>
                    </label>
                    <select id="input_tipo_inventario" class="form-input" required>
                        <option value="">Seleccione tipo</option>
                        <option value="NORMAL" selected>Normal (unitario)</option>
                        <option value="QUINTAL">Quintal (por peso)</option>
                    </select>
                </div>

                <!-- UNIDAD DE MEDIDA -->
                <div class="form-group">
                    <label class="form-label-custom">
                        <span>Unidad de Medida</span>
                        <span class="required">*</span>
                    </label>
                    <select id="input_unidad" class="form-input" required>
                        <option value="">Seleccione unidad</option>
                        {% for unidad in unidades_medida %}
                        <option value="{{ unidad.nombre }}">{{ unidad.nombre }} ({{ unidad.abreviatura }})</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ‚úÖ PESO INICIAL QUINTAL -->
                <div class="form-group" id="campo-peso-inicial" style="display: none;">
                    <label class="form-label-custom">
                        <span>‚öñÔ∏è Peso Inicial del Quintal</span>
                        <span class="required">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="input_peso_inicial" 
                        class="form-input" 
                        step="0.01" 
                        min="0.01"
                        placeholder="Ej: 100.00"
                    >
                    <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #64748b;">
                        <i class="bi bi-info-circle"></i>
                        Peso inicial total del quintal en la unidad seleccionada
                    </div>
                </div>

                <!-- CAMPO IVA -->
                <div class="form-group">
                    <label class="form-label-custom">
                        <span>üìä ¬øAplica IVA?</span>
                    </label>
                    <select id="input_iva" class="form-input" onchange="mostrarInfoIVA()">
                        <option value="0">No aplica IVA (0%)</option>
                        <option value="{{ iva_default }}" selected>S√≠, aplica IVA ({{ iva_default }}%)</option>
                    </select>
                    <div id="info-iva" style="margin-top: 0.5rem; background: #dbeafe; border: 2px solid #3b82f6; border-radius: 8px; padding: 0.75rem; display: none;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; color: #1e40af; font-weight: 600; font-size: 0.85rem;">
                            <span>‚ÑπÔ∏è</span>
                            <span>IVA configurado: <strong>{{ iva_default }}%</strong> (puede cambiarse en Configuraci√≥n del Sistema)</span>
                        </div>
                    </div>
                </div>

                <!-- CANTIDAD DE UNIDADES (STOCK) -->
                <div class="form-group">
                    <label class="form-label-custom">
                        <span>üì¶ Cantidad de Stock</span>
                        <span class="required">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="input_cantidad" 
                        class="form-input" 
                        min="1" 
                        placeholder="Ej: 50"
                        required
                    >
                </div>

                <!-- COSTO UNITARIO -->
                <div class="form-group">
                    <label class="form-label-custom">
                        <span>Costo Unitario</span>
                        <span class="required">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="input_costo" 
                        class="form-input" 
                        step="0.01" 
                        min="0"
                        placeholder="Ej: 5.50"
                        required
                        oninput="calcularPrecioVenta()"
                        onchange="calcularPrecioVenta()"
                    >
                </div>

                <!-- PRECIO DE VENTA -->
                <div class="form-group">
                    <label class="form-label-custom">
                        <span>üí∞ Precio de Venta (Calculado)</span>
                        <span class="required">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="input_precio" 
                        class="form-input" 
                        step="0.01" 
                        min="0"
                        placeholder="Se calcula autom√°ticamente"
                        required
                        style="background: linear-gradient(135deg, #f1f5f9, #e2e8f0); border: 2px solid #cbd5e1;"
                    >
                </div>

                <!-- LOTE -->
                <div class="form-group">
                    <label class="form-label-custom">
                        <span>Lote del Proveedor</span>
                    </label>
                    <input 
                        type="text" 
                        id="input_lote" 
                        class="form-input" 
                        placeholder="Ej: L-2025-001"
                    >
                </div>

                <!-- FECHA DE VENCIMIENTO -->
                <div class="form-group">
                    <label class="form-label-custom">
                        <span>Fecha de Vencimiento</span>
                    </label>
                    <input 
                        type="date" 
                        id="input_fecha_vencimiento" 
                        class="form-input"
                    >
                </div>

                <!-- DESCRIPCI√ìN -->
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label-custom">
                        <span>Descripci√≥n</span>
                    </label>
                    <textarea 
                        id="input_descripcion" 
                        class="form-input" 
                        rows="3"
                        placeholder="Descripci√≥n adicional del producto..."
                    ></textarea>
                </div>
            </div>

            <!-- BOTONES DE ACCI√ìN -->
            <div class="action-buttons">
                <button type="button" class="btn-custom btn-secondary-custom" onclick="limpiarFormulario()">
                    <i class="bi bi-x-circle"></i>
                    Limpiar
                </button>
                <button type="submit" class="btn-custom btn-primary-custom">
                    <i class="bi bi-plus-circle"></i>
                    Agregar Producto
                </button>
                <button type="button" class="btn-custom btn-success-custom" onclick="abrirModalProductos()" id="btn-ver-lista" style="display: none;">
                    <i class="bi bi-eye"></i>
                    Ver Lista de Productos
                </button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL DE GESTI√ìN DE PRODUCTOS -->
<div id="modal-productos" class="modal-custom">
    <div class="modal-content-custom">
        <div class="modal-header-custom">
            <h3>
                <i class="bi bi-box-seam"></i>
                Gesti√≥n de Productos
            </h3>
            <button class="btn-close-modal" onclick="cerrarModalProductos()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <div class="modal-body-custom">
            <!-- ALERTA INFORMATIVA -->
            <div class="info-alert">
                <div class="info-alert-content">
                    <div class="info-alert-icon">üìã</div>
                    <div>
                        <h4>Gesti√≥n Completa de Productos</h4>
                        <p>
                            <strong>‚úì Editar:</strong> Modifica cualquier producto antes de procesar<br>
                            <strong>‚úì Eliminar:</strong> Quita productos de la lista<br>
                            <strong>‚úì C√≥digos:</strong> Especifica cu√°ntos c√≥digos de barras generar por producto<br>
                            <strong>‚úì Imprimir:</strong> Procesa todo y genera los c√≥digos de barras
                        </p>
                    </div>
                </div>
            </div>

            <!-- ESTADO VAC√çO -->
            <div id="productos-vacio" class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <h3>No hay productos agregados</h3>
                <p>Agrega productos usando el formulario principal</p>
            </div>

            <!-- TABLA DE PRODUCTOS -->
            <div id="productos-tabla-container" style="display: none;">
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th style="width: 4%;">#</th>
                            <th style="width: 7%;">Imagen</th>
                            <th style="width: 18%;">Producto</th>
                            <th style="width: 10%;">Marca</th>
                            <th style="width: 10%;">Categor√≠a</th>
                            <th style="width: 8%;">Stock</th>
                            <th style="width: 9%;">Costo Unit.</th>
                            <th style="width: 9%;">Subtotal</th>
                            <th style="width: 10%;">üè∑Ô∏è C√≥digos</th>
                            <th style="width: 15%;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productos-lista">
                        <!-- Productos din√°micos -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="modal-footer-custom">
            <div class="total-summary">
                <div class="total-item">
                    <span class="total-label">Total Inversi√≥n</span>
                    <span class="total-value" id="total-inversion">$0.00</span>
                </div>
                <div class="total-item">
                    <span class="total-label">üè∑Ô∏è Total C√≥digos</span>
                    <span class="total-value highlight" id="total-codigos">0</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button class="btn-custom btn-danger-custom" onclick="limpiarLista()">
                    <i class="bi bi-trash"></i>
                    Limpiar Todo
                </button>
                <button class="btn-custom btn-secondary-custom" onclick="cerrarModalProductos()">
                    <i class="bi bi-x-circle"></i>
                    Cerrar
                </button>
                <button class="btn-custom btn-warning-custom" onclick="procesarInventario()">
                    <i class="bi bi-printer"></i>
                    Imprimir C√≥digos
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE EDICI√ìN DE PRODUCTO -->
<div id="modal-editar" class="modal-custom">
    <div class="modal-content-custom" style="max-width: 900px;">
        <div class="modal-header-custom">
            <h3>
                <i class="bi bi-pencil"></i>
                Editar Producto
            </h3>
            <button class="btn-close-modal" onclick="cerrarModalEditar()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <div class="modal-body-custom">
            <form id="form-editar" onsubmit="event.preventDefault(); guardarEdicion();">
                <input type="hidden" id="edit_producto_id">
                
                <div class="form-grid">
                    <!-- IMAGEN -->
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label class="form-label-custom">
                            <span>üì∑ Imagen del Producto</span>
                        </label>
                        <input 
                            type="file" 
                            id="edit_imagen" 
                            class="form-input" 
                            accept="image/*"
                            onchange="previsualizarImagenEditar(this)"
                        >
                        <div id="edit-preview-container" class="image-preview-container">
                            <img id="edit-preview" class="image-preview" alt="Preview">
                            <span class="image-preview-badge">‚úì Imagen Cargada</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">
                            <span>Nombre del Producto</span>
                            <span class="required">*</span>
                        </label>
                        <input type="text" id="edit_nombre" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">
                            <span>Marca</span>
                            <span class="required">*</span>
                        </label>
                        <select id="edit_marca" class="form-input" required>
                            <option value="">Seleccione una marca</option>
                            {% for marca in marcas %}
                            <option value="{{ marca.id }}">{{ marca.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">
                            <span>Categor√≠a</span>
                            <span class="required">*</span>
                        </label>
                        <select id="edit_categoria" class="form-input" required onchange="calcularPrecioVentaEditar()">
                            <option value="">Seleccione una categor√≠a</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}">{{ categoria.nombre }} ({{ categoria.margen_ganancia_sugerido }}% ganancia)</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">
                            <span>Proveedor</span>
                            <span class="required">*</span>
                        </label>
                        <select id="edit_proveedor" class="form-input" required>
                            <option value="">Seleccione un proveedor</option>
                            {% for proveedor in proveedores %}
                            <option value="{{ proveedor.id }}">{{ proveedor.nombre_comercial }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- TIPO DE INVENTARIO EN EDICI√ìN -->
                    <div class="form-group">
                        <label class="form-label-custom">
                            <span>üì¶ Tipo de Inventario</span>
                            <span class="required">*</span>
                        </label>
                        <select id="edit_tipo_inventario" class="form-input" required>
                            <option value="">Seleccione tipo</option>
                            <option value="NORMAL">Normal (unitario)</option>
                            <option value="QUINTAL">Quintal (por peso)</option>
                        </select>
                    </div>

                    <!-- UNIDAD DE MEDIDA EN EDICI√ìN -->
                    <div class="form-group">
                        <label class="form-label-custom">
                            <span>Unidad de Medida</span>
                            <span class="required">*</span>
                        </label>
                        <select id="edit_unidad" class="form-input" required>
                            <option value="">Seleccione unidad</option>
                            {% for unidad in unidades_medida %}
                            <option value="{{ unidad.nombre }}">{{ unidad.nombre }} ({{ unidad.abreviatura }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- CAMPO IVA EN EDICI√ìN -->
                    <div class="form-group">
                        <label class="form-label-custom">
                            <span>üìä ¬øAplica IVA?</span>
                        </label>
                        <select id="edit_iva" class="form-input">
                            <option value="0">No aplica IVA (0%)</option>
                            <option value="{{ iva_default }}">S√≠, aplica IVA ({{ iva_default }}%)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">
                            <span>Cantidad de Stock</span>
                            <span class="required">*</span>
                        </label>
                        <input type="number" id="edit_cantidad" class="form-input" min="1" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">
                            <span>Costo Unitario</span>
                            <span class="required">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="edit_costo" 
                            class="form-input" 
                            step="0.01" 
                            min="0" 
                            required
                            oninput="calcularPrecioVentaEditar()"
                            onchange="calcularPrecioVentaEditar()"
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">
                            <span>üí∞ Precio de Venta (Calculado)</span>
                            <span class="required">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="edit_precio" 
                            class="form-input" 
                            step="0.01" 
                            min="0" 
                            required
                            placeholder="Se calcula autom√°ticamente"
                            style="background: linear-gradient(135deg, #f1f5f9, #e2e8f0); border: 2px solid #cbd5e1;"
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">
                            <span>Lote del Proveedor</span>
                        </label>
                        <input type="text" id="edit_lote" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">
                            <span>Fecha de Vencimiento</span>
                        </label>
                        <input type="date" id="edit_fecha_vencimiento" class="form-input">
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label class="form-label-custom">
                            <span>Descripci√≥n</span>
                        </label>
                        <textarea id="edit_descripcion" class="form-input" rows="3"></textarea>
                    </div>
                </div>

                <div class="action-buttons" style="margin-top: 1.5rem; padding-top: 1.5rem;">
                    <button type="button" class="btn-custom btn-secondary-custom" onclick="cerrarModalEditar()">
                        <i class="bi bi-x-circle"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn-custom btn-success-custom">
                        <i class="bi bi-check-circle"></i>
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL DE CONFIRMACI√ìN DE IMPRESI√ìN -->
<div id="modal-confirmacion" class="modal-custom">
    <div class="modal-content-custom" style="max-width: 600px;">
        <div class="modal-header-custom" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            <h3>
                <i class="bi bi-exclamation-triangle"></i>
                Confirmar Impresi√≥n
            </h3>
            <button class="btn-close-modal" onclick="cerrarModalConfirmacion()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <div class="modal-body-custom">
            <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 12px; padding: 2rem; margin-bottom: 1.5rem;">
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                    <h3 style="color: #92400e; margin-bottom: 1rem;">¬øEst√° seguro de procesar esta entrada?</h3>
                    <p style="color: #92400e; line-height: 1.6; margin-bottom: 1.5rem;">
                        Esta acci√≥n guardar√° todos los productos en la base de datos y generar√° los c√≥digos de barras.<br>
                        <strong>Esta operaci√≥n no se puede deshacer.</strong>
                    </p>
                </div>
            </div>

            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                <h4 style="margin-top: 0; color: #1e293b;">Resumen de la operaci√≥n:</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem;">Total Productos</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;" id="confirm-productos">0</div>
                    </div>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem;">Total Unidades</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;" id="confirm-unidades">0</div>
                    </div>
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; border: 2px solid #f59e0b;">
                        <div style="font-size: 0.85rem; color: #92400e; margin-bottom: 0.5rem;">üè∑Ô∏è Total C√≥digos</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;" id="confirm-codigos">0</div>
                    </div>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem;">Inversi√≥n Total</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;" id="confirm-inversion">$0.00</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer-custom">
            <button class="btn-custom btn-secondary-custom" onclick="cerrarModalConfirmacion()">
                <i class="bi bi-x-circle"></i>
                Cancelar
            </button>
            <button class="btn-custom btn-warning-custom" onclick="confirmarProcesamiento()">
                <i class="bi bi-check-circle"></i>
                S√≠, Procesar e Imprimir
            </button>
        </div>
    </div>
</div>

<!-- MODAL DE C√ìDIGOS GENERADOS -->
<div id="modal-codigos" class="modal-custom">
    <div class="modal-content-custom" style="max-width: 900px;">
        <div class="modal-header-custom" style="background: linear-gradient(135deg, #10b981, #059669);">
            <h3>
                <i class="bi bi-check-circle"></i>
                C√≥digos de Barras Generados
            </h3>
            <button class="btn-close-modal" onclick="cerrarModalCodigos()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <div class="modal-body-custom">
            <div style="background: #dcfce7; border: 2px solid #22c55e; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <strong style="color: #166534; font-size: 1.1rem;">‚úÖ Entrada Procesada Exitosamente</strong>
                <p style="color: #166534; margin: 0.5rem 0 0 0; line-height: 1.6;">
                    Los productos han sido guardados en el inventario y los c√≥digos de barras est√°n listos para descargar.
                </p>
            </div>

            <div id="lista-codigos-generados">
                <!-- Se llena din√°micamente -->
            </div>
        </div>

        <div class="modal-footer-custom">
            <button class="btn-custom btn-secondary-custom" onclick="cerrarModalCodigos()">
                <i class="bi bi-x-circle"></i>
                Cerrar
            </button>
            <button class="btn-custom btn-warning-custom" onclick="descargarTodosPDFs()">
                <i class="bi bi-download"></i>
                Descargar Todos los PDFs
            </button>
        </div>
    </div>
</div>

<!-- MODAL DE SELECCI√ìN DE QUINTALES -->
<div id="modal-seleccionar-quintal" class="modal-custom">
    <div class="modal-content-custom" style="max-width: 1200px;">
        <div class="modal-header-custom">
            <h3>
                <i class="bi bi-box-seam"></i>
                Seleccione Quintal a Reabastecer
            </h3>
            <button class="btn-close-modal" onclick="cerrarModalQuintales()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <div class="modal-body-custom">
            <!-- B√öSQUEDA -->
            <div style="margin-bottom: 1.5rem;">
                <input 
                    type="text" 
                    id="buscar-quintal" 
                    class="form-input" 
                    placeholder="üîç Buscar por c√≥digo o producto..."
                    style="width: 100%;"
                    oninput="filtrarQuintales(this.value)"
                >
            </div>

            <!-- TABLA DE QUINTALES -->
            <div id="quintales-disponibles-container" style="max-height: 500px; overflow-y: auto;">
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th style="width: 15%;">C√ìDIGO √öNICO</th>
                            <th style="width: 20%;">PRODUCTO</th>
                            <th style="width: 10%;">ESTADO</th>
                            <th style="width: 25%;">PESO ACTUAL/INICIAL</th>
                            <th style="width: 15%;">PROVEEDOR</th>
                            <th style="width: 15%;">FECHA RECEPCI√ìN</th>
                        </tr>
                    </thead>
                    <tbody id="quintales-lista">
                        <!-- Se llena din√°micamente -->
                    </tbody>
                </table>
                
                <!-- ESTADO VAC√çO -->
                <div id="quintales-vacio" style="display: none; text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; opacity: 0.3; margin-bottom: 1rem;">üì¶</div>
                    <h3 style="color: #64748b;">No hay quintales disponibles</h3>
                    <p style="color: #94a3b8;">Crea nuevos quintales usando "Crear Nuevo Quintal"</p>
                </div>
            </div>
        </div>

        <!-- FOOTER CON BOTONES -->
        <div class="modal-footer-custom" style="flex-direction: column; gap: 1rem; align-items: stretch;">
            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="bi bi-info-circle" style="color: #92400e; font-size: 1.2rem;"></i>
                    <span style="color: #92400e; font-weight: 600; font-size: 0.9rem;">
                        üí° <strong>¬øProducto nuevo?</strong> Haz clic en "Crear Nuevo Quintal" | <strong>¬øReabastecer?</strong> Selecciona un quintal de la lista
                    </span>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: space-between;">
                <button class="btn-custom btn-secondary-custom" onclick="cerrarModalQuintales()">
                    <i class="bi bi-x-circle"></i>
                    Cancelar
                </button>
                <button class="btn-custom btn-success-custom" onclick="crearNuevoQuintal()">
                    <i class="bi bi-plus-circle"></i>
                    Crear Nuevo Quintal
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ========================================
// ESTADO GLOBAL
// ========================================
let productos = [];
let contadorProductos = 0;
let quintalSeleccionado = null;
let quintalesTodosData = [];

// ========================================
// DATOS DE CATEGOR√çAS CON M√ÅRGENES
// ========================================
const categoriasData = {
    {% for categoria in categorias %}
    "{{ categoria.id }}": {
        nombre: "{{ categoria.nombre|escapejs }}",
        margen_ganancia: parseFloat("{{ categoria.margen_ganancia_sugerido }}"),
        descuento_maximo: parseFloat("{{ categoria.descuento_maximo_permitido }}")
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

// IVA DESDE CONFIGURACI√ìN DEL SISTEMA
const IVA_DEFAULT = parseFloat("{{ iva_default }}");

console.log('‚úÖ Categor√≠as cargadas:', categoriasData);
console.log('‚úÖ IVA configurado:', IVA_DEFAULT + '%');

// ========================================
// GESTI√ìN DE QUINTALES
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Sistema de entrada de inventario iniciado');
    
    // Listener para tipo de inventario
    document.getElementById('input_tipo_inventario').addEventListener('change', function() {
        const valor = this.value;
        const campoPesoInicial = document.getElementById('campo-peso-inicial');
        const inputPesoInicial = document.getElementById('input_peso_inicial');
        
        console.log('üì¶ Tipo de inventario seleccionado:', valor);
        
        if (valor === 'QUINTAL') {
            // Mostrar campo de peso inicial
            campoPesoInicial.style.display = 'block';
            inputPesoInicial.setAttribute('required', 'required');
            
            // Abrir modal de selecci√≥n de quintales
            abrirModalSeleccionarQuintal();
        } else {
            // Ocultar campo de peso inicial
            campoPesoInicial.style.display = 'none';
            inputPesoInicial.removeAttribute('required');
            inputPesoInicial.value = '';
            
            // Limpiar selecci√≥n
            document.getElementById('input_nombre').disabled = false;
            quintalSeleccionado = null;
        }
    });
    
    document.getElementById('input_nombre').focus();
    mostrarInfoIVA();
});

async function abrirModalSeleccionarQuintal() {
    console.log('üîç Cargando quintales disponibles...');
    
    try {
        const response = await fetch('/api/inventario/quintales-disponibles/');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Quintales recibidos:', data);
        
        quintalesTodosData = data.quintales || [];
        
        if (quintalesTodosData.length === 0) {
            console.log('‚ö†Ô∏è No hay quintales disponibles');
            document.getElementById('quintales-vacio').style.display = 'block';
            document.getElementById('quintales-lista').innerHTML = '';
        } else {
            console.log(`‚úÖ Se encontraron ${quintalesTodosData.length} quintales`);
            document.getElementById('quintales-vacio').style.display = 'none';
            renderizarQuintales(quintalesTodosData);
        }
        
        document.getElementById('modal-seleccionar-quintal').classList.add('show');
        
    } catch (error) {
        console.error('‚ùå Error cargando quintales:', error);
        mostrarNotificacion('Error al cargar quintales: ' + error.message, 'error');
    }
}

function cerrarModalQuintales() {
    document.getElementById('modal-seleccionar-quintal').classList.remove('show');
    if (!quintalSeleccionado) {
        // Si no se seleccion√≥ ning√∫n quintal, volver a NORMAL
        document.getElementById('input_tipo_inventario').value = 'NORMAL';
        document.getElementById('campo-peso-inicial').style.display = 'none';
        document.getElementById('input_peso_inicial').removeAttribute('required');
    }
}

function crearNuevoQuintal() {
    console.log('üÜï Modo: Crear Nuevo Quintal');
    
    // Limpiar selecci√≥n de quintal
    quintalSeleccionado = null;
    
    // Habilitar el campo de nombre
    document.getElementById('input_nombre').disabled = false;
    
    // CERRAR EL MODAL CORRECTAMENTE
    const modal = document.getElementById('modal-seleccionar-quintal');
    modal.classList.remove('show');
    modal.style.display = 'none';
    
    // Remover el backdrop
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
        backdrop.remove();
    }
    
    // Restaurar scroll del body
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
    
    // MOSTRAR EL CAMPO DE PESO INICIAL
    const campoPesoInicial = document.getElementById('campo-peso-inicial');
    if (campoPesoInicial) {
        campoPesoInicial.style.display = 'block';
        document.getElementById('input_peso_inicial').setAttribute('required', 'required');
    }
    
    console.log('‚úÖ Modo crear nuevo quintal activado');
    console.log('‚úÖ Campo peso inicial mostrado');
    
    mostrarNotificacion('‚úÖ Modo: Crear Nuevo Quintal. Completa todos los datos incluyendo el peso inicial.', 'success');
}

function renderizarQuintales(quintales) {
    const lista = document.getElementById('quintales-lista');
    lista.innerHTML = '';
    
    console.log('üìã Renderizando', quintales.length, 'quintales');
    
    if (quintales.length === 0) {
        document.getElementById('quintales-vacio').style.display = 'block';
        return;
    }
    
    document.getElementById('quintales-vacio').style.display = 'none';
    
    quintales.forEach(quintal => {
        const porcentaje = parseFloat(quintal.porcentaje_restante);
        const pesoActual = parseFloat(quintal.peso_actual);
        const pesoInicial = parseFloat(quintal.peso_inicial);
        
        let colorBarra;
        if (porcentaje >= 70) {
            colorBarra = 'linear-gradient(90deg, #10b981, #059669)';
        } else if (porcentaje >= 30) {
            colorBarra = 'linear-gradient(90deg, #f59e0b, #d97706)';
        } else {
            colorBarra = 'linear-gradient(90deg, #ef4444, #dc2626)';
        }
        
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.style.transition = 'all 0.2s ease';
        
        tr.innerHTML = `
            <td>
                <strong style="font-family: 'Courier New', monospace; font-size: 1.1rem; color: #1e293b;">
                    ${quintal.codigo_unico}
                </strong>
            </td>
            <td>
                <div style="font-weight: 600; color: #1e293b;">${quintal.producto_nombre}</div>
                <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.25rem;">
                    ${quintal.marca_nombre || 'Sin marca'}
                </div>
            </td>
            <td>
                <span style="
                    background: ${quintal.estado === 'DISPONIBLE' ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)'};
                    color: ${quintal.estado === 'DISPONIBLE' ? '#059669' : '#dc2626'};
                    padding: 0.4rem 0.8rem;
                    border-radius: 8px;
                    font-size: 0.8rem;
                    font-weight: 700;
                    border: 1px solid ${quintal.estado === 'DISPONIBLE' ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};
                    display: inline-block;
                ">
                    ${quintal.estado === 'DISPONIBLE' ? '‚úì Disponible' : '‚úó No disponible'}
                </span>
            </td>
            <td>
                <div style="margin-bottom: 0.5rem;">
                    <div style="
                        position: relative;
                        height: 28px;
                        background: #e2e8f0;
                        border-radius: 14px;
                        overflow: hidden;
                        border: 2px solid ${porcentaje >= 70 ? '#10b981' : porcentaje >= 30 ? '#f59e0b' : '#ef4444'};
                    ">
                        <div style="
                            position: absolute;
                            left: 0;
                            top: 0;
                            height: 100%;
                            width: ${porcentaje}%;
                            background: ${colorBarra};
                            transition: width 0.3s ease;
                            border-radius: 12px;
                        "></div>
                        
                        <div style="
                            position: absolute;
                            left: 0;
                            top: 0;
                            width: 100%;
                            height: 100%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: 700;
                            font-size: 0.9rem;
                            color: ${porcentaje < 50 ? 'white' : '#1e293b'};
                            z-index: 2;
                            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
                        ">
                            ${pesoActual.toFixed(2)}/${pesoInicial.toFixed(2)} ${quintal.unidad_medida} (${porcentaje.toFixed(1)}%)
                        </div>
                    </div>
                </div>
            </td>
            <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="bi bi-building" style="color: #64748b;"></i>
                    <span style="font-weight: 500;">${quintal.proveedor_nombre}</span>
                </div>
            </td>
            <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="bi bi-calendar" style="color: #64748b;"></i>
                    <span>${quintal.fecha_recepcion}</span>
                </div>
            </td>
        `;
        
        tr.addEventListener('mouseenter', function() {
            this.style.background = '#f8fafc';
            this.style.transform = 'scale(1.01)';
        });
        
        tr.addEventListener('mouseleave', function() {
            this.style.background = 'white';
            this.style.transform = 'scale(1)';
        });
        
        tr.addEventListener('click', function() {
            seleccionarQuintal(quintal);
        });
        
        lista.appendChild(tr);
    });
}

function seleccionarQuintal(quintal) {
    console.log('‚úÖ Quintal seleccionado:', quintal);
    quintalSeleccionado = quintal;
    
    // Llenar el nombre del producto
    document.getElementById('input_nombre').value = quintal.producto_nombre;
    document.getElementById('input_nombre').disabled = true;
    
    // Ocultar el campo de peso inicial (ya que es un quintal existente)
    document.getElementById('campo-peso-inicial').style.display = 'none';
    document.getElementById('input_peso_inicial').removeAttribute('required');
    
    cerrarModalQuintales();
    mostrarNotificacion(`‚úÖ Quintal ${quintal.codigo_unico} seleccionado para reabastecer`, 'success');
}

function filtrarQuintales(busqueda) {
    const busquedaLower = busqueda.toLowerCase();
    
    if (!busqueda.trim()) {
        renderizarQuintales(quintalesTodosData);
        return;
    }
    
    const filtrados = quintalesTodosData.filter(q => 
        q.codigo_unico.toLowerCase().includes(busquedaLower) ||
        q.producto_nombre.toLowerCase().includes(busquedaLower) ||
        q.proveedor_nombre.toLowerCase().includes(busquedaLower)
    );
    
    renderizarQuintales(filtrados);
}

// ========================================
// FUNCI√ìN PARA MOSTRAR INFO DE IVA
// ========================================
function mostrarInfoIVA() {
    const ivaSelect = document.getElementById('input_iva');
    const infoDiv = document.getElementById('info-iva');
    
    if (parseFloat(ivaSelect.value) > 0) {
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
}

// ========================================
// CALCULAR PRECIO DE VENTA AUTOM√ÅTICO
// ========================================
function calcularPrecioVenta() {
    try {
        const categoriaId = document.getElementById('input_categoria').value;
        const costoInput = document.getElementById('input_costo');
        const precioInput = document.getElementById('input_precio');
        const costoUnitario = parseFloat(costoInput.value) || 0;
        
        if (costoUnitario <= 0) {
            precioInput.value = '';
            return;
        }
        
        if (!categoriaId) {
            precioInput.value = '';
            precioInput.placeholder = '‚ö†Ô∏è Primero selecciona una categor√≠a';
            precioInput.style.background = 'linear-gradient(135deg, #fee2e2, #fecaca)';
            precioInput.style.borderColor = '#ef4444';
            return;
        }
        
        const categoria = categoriasData[categoriaId] || categoriasData[String(categoriaId)];
        
        if (!categoria) {
            console.error('‚ùå Categor√≠a no encontrada:', categoriaId);
            return;
        }
        
        const margenGanancia = parseFloat(categoria.margen_ganancia) || 0;
        const ganancia = costoUnitario * (margenGanancia / 100);
        const precioVenta = costoUnitario + ganancia;
        
        precioInput.style.background = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
        precioInput.style.borderColor = '#10b981';
        precioInput.value = precioVenta.toFixed(2);
        
        actualizarInfoCalculo(costoUnitario, margenGanancia, ganancia, precioVenta);
    } catch (error) {
        console.error('‚ùå Error en calcularPrecioVenta:', error);
    }
}

function calcularPrecioVentaEditar() {
    try {
        const categoriaId = document.getElementById('edit_categoria').value;
        const costoInput = document.getElementById('edit_costo');
        const precioInput = document.getElementById('edit_precio');
        const costoUnitario = parseFloat(costoInput.value) || 0;
        
        if (costoUnitario <= 0) {
            precioInput.value = '';
            return;
        }
        
        if (!categoriaId) {
            precioInput.value = '';
            precioInput.placeholder = '‚ö†Ô∏è Primero selecciona una categor√≠a';
            precioInput.style.background = 'linear-gradient(135deg, #fee2e2, #fecaca)';
            precioInput.style.borderColor = '#ef4444';
            return;
        }
        
        const categoria = categoriasData[categoriaId] || categoriasData[String(categoriaId)];
        
        if (!categoria) {
            console.error('Categor√≠a no encontrada:', categoriaId);
            return;
        }
        
        const margenGanancia = parseFloat(categoria.margen_ganancia) || 0;
        const ganancia = costoUnitario * (margenGanancia / 100);
        const precioVenta = costoUnitario + ganancia;
        
        precioInput.style.background = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
        precioInput.style.borderColor = '#10b981';
        precioInput.value = precioVenta.toFixed(2);
        
        actualizarInfoCalculoEditar(costoUnitario, margenGanancia, ganancia, precioVenta);
    } catch (error) {
        console.error('Error en calcularPrecioVentaEditar:', error);
    }
}

function actualizarInfoCalculo(costo, margen, ganancia, precioFinal) {
    try {
        let infoDiv = document.getElementById('info-calculo-precio');
        if (!infoDiv) {
            infoDiv = document.createElement('div');
            infoDiv.id = 'info-calculo-precio';
            infoDiv.style.cssText = 'margin-top: 0.5rem; background: #dcfce7; border: 2px solid #10b981; border-radius: 8px; padding: 0.75rem; animation: fadeIn 0.3s ease;';
            document.getElementById('input_precio').parentElement.appendChild(infoDiv);
        }
        
        infoDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; color: #065f46; font-weight: 700; font-size: 0.9rem;">
                <span>‚úÖ</span>
                <span>$${costo.toFixed(2)} + ${margen}% ($${ganancia.toFixed(2)}) = <strong style="color: #059669; font-size: 1.1rem;">$${precioFinal.toFixed(2)}</strong></span>
            </div>
        `;
    } catch (error) {
        console.error('Error en actualizarInfoCalculo:', error);
    }
}

function actualizarInfoCalculoEditar(costo, margen, ganancia, precioFinal) {
    try {
        let infoDiv = document.getElementById('info-calculo-precio-editar');
        if (!infoDiv) {
            infoDiv = document.createElement('div');
            infoDiv.id = 'info-calculo-precio-editar';
            infoDiv.style.cssText = 'margin-top: 0.5rem; background: #dcfce7; border: 2px solid #10b981; border-radius: 8px; padding: 0.75rem; animation: fadeIn 0.3s ease;';
            document.getElementById('edit_precio').parentElement.appendChild(infoDiv);
        }
        
        infoDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; color: #065f46; font-weight: 700; font-size: 0.9rem;">
                <span>‚úÖ</span>
                <span>$${costo.toFixed(2)} + ${margen}% ($${ganancia.toFixed(2)}) = <strong style="color: #059669; font-size: 1.1rem;">$${precioFinal.toFixed(2)}</strong></span>
            </div>
        `;
    } catch (error) {
        console.error('Error en actualizarInfoCalculoEditar:', error);
    }
}

// ========================================
// PREVISUALIZAR IMAGEN
// ========================================
function previsualizarImagen(input) {
    const preview = document.getElementById('preview-imagen');
    const container = document.getElementById('preview-imagen-container');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            container.classList.add('show');
        }
        reader.readAsDataURL(input.files[0]);
    } else {
        container.classList.remove('show');
    }
}

function previsualizarImagenEditar(input) {
    const preview = document.getElementById('edit-preview');
    const container = document.getElementById('edit-preview-container');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            container.classList.add('show');
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// ========================================
// AGREGAR PRODUCTO
// ========================================
function agregarProducto() {
    console.log('üìù Iniciando agregar producto...');
    
    const form = document.getElementById('form-producto');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const nombre = document.getElementById('input_nombre').value.trim();
    const marca_id = document.getElementById('input_marca').value;
    const marca_nombre = document.getElementById('input_marca').selectedOptions[0].text;
    const categoria_id = document.getElementById('input_categoria').value;
    const categoria_nombre = document.getElementById('input_categoria').selectedOptions[0].text;
    const proveedor_id = document.getElementById('input_proveedor').value;
    const proveedor_nombre = document.getElementById('input_proveedor').selectedOptions[0].text;
    const tipo_inventario = document.getElementById('input_tipo_inventario').value;
    
    // Obtener unidad de medida seg√∫n el tipo
    let unidad_medida = '';
    let unidad_medida_texto = '';
    
    if (tipo_inventario === 'QUINTAL') {
        // Si es quintal, la unidad ya est√° seleccionada en el campo de unidad de medida
        const selectUnidad = document.getElementById('input_unidad');
        console.log('üîç Tipo inventario:', tipo_inventario);
        console.log('üîç Select unidad:', document.getElementById('input_unidad'));
        console.log('üîç Valor selectUnidad.value:', selectUnidad ? selectUnidad.value : 'null');
        if (selectUnidad && selectUnidad.value) {
            unidad_medida = selectUnidad.value;
            unidad_medida_texto = selectUnidad.selectedOptions[0].text;
        } else {
            mostrarNotificacion('‚ö†Ô∏è Error: Debes seleccionar la unidad de medida', 'error');
            return;
        }
    } else {
        // Para productos normales
        unidad_medida = document.getElementById('input_unidad').value;
        unidad_medida_texto = document.getElementById('input_unidad').selectedOptions[0].text;
    }
    
    console.log('üìè Unidad de medida:', unidad_medida, unidad_medida_texto);
    const cantidad = parseInt(document.getElementById('input_cantidad').value);
    const costo = parseFloat(document.getElementById('input_costo').value);
    const precio = parseFloat(document.getElementById('input_precio').value);
    const lote = document.getElementById('input_lote').value.trim();
    const fecha_vencimiento = document.getElementById('input_fecha_vencimiento').value;
    const descripcion = document.getElementById('input_descripcion').value.trim();
    const iva = parseFloat(document.getElementById('input_iva').value);
    
    const inputImagen = document.getElementById('input_imagen');
    const imagenFile = inputImagen.files[0];
    const imagenPreview = document.getElementById('preview-imagen').src;

    // ‚úÖ DATOS DE QUINTAL
    let quintal_codigo_unico = null;
    let es_nuevo_quintal = false;
    let peso_inicial_quintal = null;
    
    if (tipo_inventario === 'QUINTAL') {
        if (quintalSeleccionado) {
            // Reabastecer quintal existente
            quintal_codigo_unico = quintalSeleccionado.codigo_unico;
            console.log('üîÑ Reabastecer quintal:', quintal_codigo_unico);
        } else {
            // Crear nuevo quintal
            es_nuevo_quintal = true;
            peso_inicial_quintal = parseFloat(document.getElementById('input_peso_inicial').value);
            
            if (!peso_inicial_quintal || peso_inicial_quintal <= 0) {
                mostrarNotificacion('‚ö†Ô∏è Error: Debes ingresar el peso inicial del quintal', 'error');
                return;
            }
            console.log('üÜï Crear nuevo quintal con peso inicial:', peso_inicial_quintal);
        }
    }

    if (precio <= costo) {
        mostrarNotificacion('‚ö†Ô∏è Error: El precio de venta debe ser mayor al costo.', 'error');
        calcularPrecioVenta();
        return;
    }

    if (cantidad < 1) {
        mostrarNotificacion('La cantidad debe ser mayor a 0', 'error');
        return;
    }

    const producto = {
        id: ++contadorProductos,
        nombre, marca_id, marca_nombre, categoria_id, categoria_nombre,
        proveedor_id, proveedor_nombre, tipo_inventario, unidad_medida, unidad_medida_texto,
        cantidad, cantidad_codigos: cantidad,
        costo_unitario: costo, precio_venta: precio,
        lote, fecha_vencimiento, descripcion,
        iva: iva,
        quintal_codigo_unico: quintal_codigo_unico,
        es_nuevo_quintal: es_nuevo_quintal,
        peso_inicial_quintal: peso_inicial_quintal,
        imagen_file: imagenFile,
        imagen_preview: imagenPreview,
        subtotal: cantidad * costo
    };

    console.log('‚úÖ Producto agregado:', producto);
    productos.push(producto);
    actualizarContador();
    limpiarFormulario();
    mostrarNotificacion(`‚úÖ "${nombre}" agregado correctamente`, 'success');
    
    document.getElementById('btn-ver-lista').style.display = 'flex';
    setTimeout(() => abrirModalProductos(), 500);
}

// ========================================
// ACTUALIZAR CONTADOR
// ========================================
function actualizarContador() {
    document.getElementById('contador-productos').textContent = productos.length;
}

// ========================================
// LIMPIAR FORMULARIO
// ========================================
function limpiarFormulario() {
    document.getElementById('form-producto').reset();
    document.getElementById('preview-imagen-container').classList.remove('show');
    document.getElementById('campo-peso-inicial').style.display = 'none';
    document.getElementById('input_peso_inicial').removeAttribute('required');
    document.getElementById('input_nombre').focus();
    document.getElementById('input_nombre').disabled = false;
    quintalSeleccionado = null;
}

// ========================================
// MODAL DE PRODUCTOS
// ========================================
function abrirModalProductos() {
    if (productos.length === 0) {
        mostrarNotificacion('No hay productos agregados', 'error');
        return;
    }
    
    renderizarProductos();
    document.getElementById('modal-productos').classList.add('show');
}

function cerrarModalProductos() {
    document.getElementById('modal-productos').classList.remove('show');
}

// ========================================
// RENDERIZAR PRODUCTOS
// ========================================
function renderizarProductos() {
    const lista = document.getElementById('productos-lista');
    lista.innerHTML = '';

    if (productos.length === 0) {
        document.getElementById('productos-vacio').style.display = 'block';
        document.getElementById('productos-tabla-container').style.display = 'none';
        return;
    }

    document.getElementById('productos-vacio').style.display = 'none';
    document.getElementById('productos-tabla-container').style.display = 'block';

    let totalInversion = 0;
    let totalCodigos = 0;

    productos.forEach((producto, index) => {
        const tr = document.createElement('tr');
        
        const imagenHTML = producto.imagen_preview 
            ? `<img src="${producto.imagen_preview}" class="product-image-small" alt="${producto.nombre}">`
            : `<div style="width: 60px; height: 60px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 1.5rem;">üì¶</div>`;
        
        const ivaBadge = producto.iva > 0 
            ? `<span class="badge-custom" style="background: #dbeafe; color: #1e40af; margin-left: 0.5rem;">IVA ${producto.iva}%</span>`
            : '';
        
        // Badge para tipo de quintal
        let quintalBadge = '';
        if (producto.tipo_inventario === 'QUINTAL') {
            if (producto.es_nuevo_quintal) {
                quintalBadge = `<span class="badge-custom" style="background: #d1fae5; color: #065f46; margin-left: 0.5rem;">üÜï Nuevo (${producto.peso_inicial_quintal} ${producto.unidad_medida_texto})</span>`;
            } else if (producto.quintal_codigo_unico) {
                quintalBadge = `<span class="badge-custom" style="background: #fef3c7; color: #92400e; margin-left: 0.5rem;">üîÑ ${producto.quintal_codigo_unico}</span>`;
            }
        }
        
        tr.innerHTML = `
            <td><strong>${index + 1}</strong></td>
            <td>${imagenHTML}</td>
            <td>
                <div class="product-name">${producto.nombre} ${ivaBadge} ${quintalBadge}</div>
                <div class="product-details">
                    ${producto.lote ? `Lote: ${producto.lote}` : 'Sin lote'}
                    ${producto.fecha_vencimiento ? ` | Vence: ${producto.fecha_vencimiento}` : ''}
                </div>
            </td>
            <td><span class="badge-custom badge-success">${producto.marca_nombre}</span></td>
            <td><span class="badge-custom badge-info">${producto.categoria_nombre}</span></td>
            <td>
                <strong style="font-size: 1.2rem; color: #3b82f6;">${producto.cantidad}</strong>
                <div class="product-details">${producto.unidad_medida_texto}</div>
            </td>
            <td>$${producto.costo_unitario.toFixed(2)}</td>
            <td><strong style="color: #10b981; font-size: 1.1rem;">$${producto.subtotal.toFixed(2)}</strong></td>
            <td>
                <input 
                    type="number" 
                    class="input-codigos-tabla" 
                    value="${producto.cantidad_codigos}" 
                    min="1"
                    onchange="actualizarCodigos(${producto.id}, this.value)"
                >
            </td>
            <td>
                <button class="btn-table btn-edit" onclick="editarProducto(${producto.id})">
                    <i class="bi bi-pencil"></i> Editar
                </button>
                <button class="btn-table btn-delete" onclick="eliminarProducto(${producto.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        lista.appendChild(tr);
        
        totalInversion += producto.subtotal;
        totalCodigos += producto.cantidad_codigos;
    });

    document.getElementById('total-inversion').textContent = `$${totalInversion.toFixed(2)}`;
    document.getElementById('total-codigos').textContent = totalCodigos;
}

// ========================================
// ACTUALIZAR C√ìDIGOS
// ========================================
function actualizarCodigos(id, cantidad) {
    const producto = productos.find(p => p.id === id);
    if (producto) {
        const nuevaCantidad = parseInt(cantidad) || 1;
        if (nuevaCantidad < 1) {
            mostrarNotificacion('La cantidad de c√≥digos debe ser al menos 1', 'error');
            renderizarProductos();
            return;
        }
        producto.cantidad_codigos = nuevaCantidad;
        renderizarProductos();
    }
}

// ========================================
// EDITAR PRODUCTO
// ========================================
function editarProducto(id) {
    const producto = productos.find(p => p.id === id);
    if (!producto) return;

    document.getElementById('edit_producto_id').value = producto.id;
    document.getElementById('edit_nombre').value = producto.nombre;
    document.getElementById('edit_marca').value = producto.marca_id;
    document.getElementById('edit_categoria').value = producto.categoria_id;
    document.getElementById('edit_proveedor').value = producto.proveedor_id;
    document.getElementById('edit_tipo_inventario').value = producto.tipo_inventario || 'NORMAL';
    document.getElementById('edit_unidad').value = producto.unidad_medida;
    document.getElementById('edit_cantidad').value = producto.cantidad;
    document.getElementById('edit_costo').value = producto.costo_unitario;
    document.getElementById('edit_precio').value = producto.precio_venta;
    document.getElementById('edit_lote').value = producto.lote;
    document.getElementById('edit_fecha_vencimiento').value = producto.fecha_vencimiento;
    document.getElementById('edit_descripcion').value = producto.descripcion;
    document.getElementById('edit_iva').value = producto.iva;
    
    if (producto.imagen_preview) {
        document.getElementById('edit-preview').src = producto.imagen_preview;
        document.getElementById('edit-preview-container').classList.add('show');
    }

    document.getElementById('modal-editar').classList.add('show');
    setTimeout(() => calcularPrecioVentaEditar(), 100);
}

function cerrarModalEditar() {
    document.getElementById('modal-editar').classList.remove('show');
    document.getElementById('form-editar').reset();
    document.getElementById('edit-preview-container').classList.remove('show');
}

function guardarEdicion() {
    const id = parseInt(document.getElementById('edit_producto_id').value);
    const producto = productos.find(p => p.id === id);
    if (!producto) return;

    const precio = parseFloat(document.getElementById('edit_precio').value);
    const costo = parseFloat(document.getElementById('edit_costo').value);
    
    if (precio <= costo) {
        mostrarNotificacion('‚ö†Ô∏è Error: El precio de venta debe ser mayor al costo.', 'error');
        calcularPrecioVentaEditar();
        return;
    }

    producto.nombre = document.getElementById('edit_nombre').value.trim();
    producto.marca_id = document.getElementById('edit_marca').value;
    producto.marca_nombre = document.getElementById('edit_marca').selectedOptions[0].text;
    producto.categoria_id = document.getElementById('edit_categoria').value;
    producto.categoria_nombre = document.getElementById('edit_categoria').selectedOptions[0].text;
    producto.proveedor_id = document.getElementById('edit_proveedor').value;
    producto.proveedor_nombre = document.getElementById('edit_proveedor').selectedOptions[0].text;
    producto.tipo_inventario = document.getElementById('edit_tipo_inventario').value;
    producto.unidad_medida = document.getElementById('edit_unidad').value;
    producto.unidad_medida_texto = document.getElementById('edit_unidad').selectedOptions[0].text;
    producto.cantidad = parseInt(document.getElementById('edit_cantidad').value);
    producto.costo_unitario = costo;
    producto.precio_venta = precio;
    producto.lote = document.getElementById('edit_lote').value.trim();
    producto.fecha_vencimiento = document.getElementById('edit_fecha_vencimiento').value;
    producto.descripcion = document.getElementById('edit_descripcion').value.trim();
    producto.iva = parseFloat(document.getElementById('edit_iva').value);
    producto.subtotal = producto.cantidad * costo;

    const inputImagen = document.getElementById('edit_imagen');
    if (inputImagen.files[0]) {
        producto.imagen_file = inputImagen.files[0];
        producto.imagen_preview = document.getElementById('edit-preview').src;
    }

    renderizarProductos();
    cerrarModalEditar();
    mostrarNotificacion('‚úÖ Producto actualizado correctamente', 'success');
}

// ========================================
// ELIMINAR PRODUCTO
// ========================================
function eliminarProducto(id) {
    const producto = productos.find(p => p.id === id);
    if (confirm(`¬øEliminar "${producto.nombre}"?`)) {
        productos = productos.filter(p => p.id !== id);
        actualizarContador();
        renderizarProductos();
        mostrarNotificacion('Producto eliminado', 'success');
        
        if (productos.length === 0) {
            cerrarModalProductos();
            document.getElementById('btn-ver-lista').style.display = 'none';
        }
    }
}

// ========================================
// LIMPIAR LISTA
// ========================================
function limpiarLista() {
    if (productos.length === 0) return;
    
    if (confirm(`¬øLimpiar toda la lista?\nSe eliminar√°n ${productos.length} productos.`)) {
        productos = [];
        contadorProductos = 0;
        actualizarContador();
        renderizarProductos();
        cerrarModalProductos();
        document.getElementById('btn-ver-lista').style.display = 'none';
        mostrarNotificacion('Lista limpiada', 'success');
    }
}

// ========================================
// PROCESAR INVENTARIO
// ========================================
function procesarInventario() {
    if (productos.length === 0) {
        mostrarNotificacion('No hay productos para procesar', 'error');
        return;
    }

    const totalProductos = productos.length;
    const totalUnidades = productos.reduce((sum, p) => sum + p.cantidad, 0);
    const totalCodigos = productos.reduce((sum, p) => sum + p.cantidad_codigos, 0);
    const totalInversion = productos.reduce((sum, p) => sum + p.subtotal, 0);

    document.getElementById('confirm-productos').textContent = totalProductos;
    document.getElementById('confirm-unidades').textContent = totalUnidades;
    document.getElementById('confirm-codigos').textContent = totalCodigos;
    document.getElementById('confirm-inversion').textContent = `$${totalInversion.toFixed(2)}`;

    document.getElementById('modal-confirmacion').classList.add('show');
}

function cerrarModalConfirmacion() {
    document.getElementById('modal-confirmacion').classList.remove('show');
}

async function confirmarProcesamiento() {
    console.log('üöÄ Iniciando procesamiento de inventario...');
    cerrarModalConfirmacion();
    cerrarModalProductos();

    const formData = new FormData();
    
    const productosData = productos.map(p => ({
        nombre: p.nombre, 
        marca_id: p.marca_id, 
        categoria_id: p.categoria_id,
        proveedor_id: p.proveedor_id, 
        tipo_inventario: p.tipo_inventario,
        unidad_medida: p.unidad_medida,
        cantidad: p.cantidad, 
        cantidad_codigos: p.cantidad_codigos,
        costo_unitario: p.costo_unitario, 
        precio_venta: p.precio_venta,
        lote: p.lote, 
        fecha_vencimiento: p.fecha_vencimiento,
        descripcion: p.descripcion, 
        tiene_imagen: p.imagen_file ? true : false,
        iva: p.iva,
        quintal_codigo_unico: p.quintal_codigo_unico,
        es_nuevo_quintal: p.es_nuevo_quintal,
        peso_inicial_quintal: p.peso_inicial_quintal
    }));
    
    console.log('üì¶ Datos a enviar:', productosData);
    
    formData.append('productos', JSON.stringify(productosData));
    productos.forEach((producto, index) => {
        if (producto.imagen_file) {
            formData.append(`imagen_${index}`, producto.imagen_file);
        }
    });

    try {
        mostrarNotificacion('‚è≥ Procesando inventario...', 'success');

        const response = await fetch('/panel/api/inventario/procesar-entrada-unificada/', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            body: formData
        });

        const result = await response.json();
        console.log('üì© Respuesta del servidor:', result);

        if (result.success) {
            mostrarModalCodigosGenerados(result.codigos_generados);
            
            productos = [];
            contadorProductos = 0;
            actualizarContador();
            document.getElementById('btn-ver-lista').style.display = 'none';
            
            mostrarNotificacion(`‚úÖ ${result.productos_creados} productos procesados exitosamente`, 'success');
        } else {
            console.error('‚ùå Error del servidor:', result.error);
            mostrarNotificacion(result.error || 'Error al procesar', 'error');
        }
    } catch (error) {
        console.error('‚ùå Error de conexi√≥n:', error);
        mostrarNotificacion('Error de conexi√≥n: ' + error.message, 'error');
    }
}

// ========================================
// MODAL DE C√ìDIGOS GENERADOS
// ========================================
function mostrarModalCodigosGenerados(codigos) {
    const lista = document.getElementById('lista-codigos-generados');
    lista.innerHTML = '';

    // üêõ DEBUG: Ver qu√© datos llegan
    console.log('üì¶ C√≥digos recibidos:', codigos);
    
    codigos.forEach((codigo, index) => {
        // üêõ DEBUG: Ver estructura de cada c√≥digo
        console.log(`C√≥digo ${index}:`, codigo);
        
        // üîß FIX: Detectar qu√© propiedad tiene el ID del producto
        const productoId = codigo.producto_id || codigo.id || codigo.producto || null;
        
        if (!productoId) {
            console.error('‚ö†Ô∏è No se pudo obtener el ID del producto:', codigo);
        }
        
        const item = document.createElement('div');
        item.style.cssText = 'background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;';
        item.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h4 style="margin: 0 0 0.5rem 0; color: #1e293b;">${index + 1}. ${codigo.producto_nombre}</h4>
                    <p style="margin: 0 0 0.5rem 0; color: #64748b; font-size: 0.9rem;">
                        <strong>Unidad:</strong> ${codigo.unidad_medida || 'UNIDAD'} | 
                        <strong>Stock:</strong> ${codigo.cantidad_stock || 0} unidades
                    </p>
                    <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; padding: 0.75rem 1rem; border-radius: 8px; display: inline-block; margin-top: 0.5rem;">
                        <strong style="color: #92400e;">üè∑Ô∏è C√≥digo: ${codigo.codigo_base}</strong>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <span style="background: #dcfce7; color: #166534; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 0.9rem; border: 2px solid #22c55e;">
                            ‚úì ${codigo.cantidad_codigos} c√≥digos generados
                        </span>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    ${productoId ? `
                        <!-- ‚ú® Bot√≥n de imprimir (solo si hay productoId) -->
                        <button onclick="imprimirCodigoBarras('${productoId}', ${codigo.cantidad_codigos})" 
                                class="btn-custom btn-primary-custom" 
                                style="margin: 0; white-space: nowrap;">
                            <i class="bi bi-printer"></i> Imprimir (${codigo.cantidad_codigos})
                        </button>
                    ` : `
                        <!-- Bot√≥n deshabilitado si no hay ID -->
                        <button class="btn-custom btn-primary-custom" 
                                disabled
                                style="margin: 0; white-space: nowrap; opacity: 0.5;">
                            <i class="bi bi-printer"></i> Sin ID
                        </button>
                    `}
                    
                    <!-- PDF como backup -->
                    <a href="${codigo.pdf_url}" 
                       target="_blank" 
                       class="btn-custom btn-secondary-custom" 
                       style="margin: 0; text-align: center; text-decoration: none; color: inherit;">
                        <i class="bi bi-download"></i> PDF Backup
                    </a>
                </div>
            </div>
        `;
        lista.appendChild(item);
    });

    document.getElementById('modal-codigos').classList.add('show');
}

async function imprimirCodigoBarras(productoId, cantidadCopias = 1) {
    console.log('üñ®Ô∏è Imprimiendo c√≥digo de barras:', {
        productoId,
        cantidadCopias
    });
    
    try {
        // Mostrar indicador de carga
        mostrarNotificacion(`‚è≥ Enviando ${cantidadCopias} etiqueta(s) a la impresora...`, 'success');
        
        // Obtener CSRF token
        const csrfToken = getCookie('csrftoken');
        
        if (!csrfToken) {
            throw new Error('Token CSRF no encontrado');
        }
        
        // Realizar petici√≥n para imprimir
        const response = await fetch(`/panel/inventario/productos/${productoId}/imprimir-codigo/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                copias: cantidadCopias
            }),
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Error en la solicitud');
        }
        
        if (data.success) {
            console.log('‚úÖ Impresi√≥n enviada correctamente:', data);
            
            // Mostrar notificaci√≥n de √©xito
            mostrarNotificacion(
                `‚úÖ ${cantidadCopias} etiqueta(s) enviada(s) a imprimir en ${data.impresora}`,
                'success'
            );
            
        } else {
            throw new Error(data.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('‚ùå Error imprimiendo c√≥digo de barras:', error);
        
        // Mostrar notificaci√≥n de error con detalles
        mostrarNotificacion(
            `‚ùå Error al imprimir: ${error.message}. Verifica que la impresora est√© configurada y el agente est√© activo.`,
            'error'
        );
    }
}

function cerrarModalCodigos() {
    document.getElementById('modal-codigos').classList.remove('show');
}

function descargarTodosPDFs() {
    // Cambiar el nombre de la funci√≥n o crear una nueva
    imprimirTodosLosCodigos();
}

async function imprimirTodosLosCodigos() {
    const items = document.querySelectorAll('#lista-codigos-generados > div');
    
    if (items.length === 0) {
        mostrarNotificacion('No hay c√≥digos para imprimir', 'error');
        return;
    }

    mostrarNotificacion(`üñ®Ô∏è Enviando ${items.length} productos a imprimir...`, 'success');
    
    let exitosos = 0;
    let errores = 0;
    
    for (let i = 0; i < items.length; i++) {
        const buttons = items[i].querySelectorAll('button[onclick*="imprimirCodigoBarras"]');
        if (buttons.length > 0) {
            try {
                const onclickAttr = buttons[0].getAttribute('onclick');
                const match = onclickAttr.match(/imprimirCodigoBarras\('([^']+)',\s*(\d+)\)/);
                
                if (match) {
                    const productoId = match[1];
                    const cantidad = parseInt(match[2]);
                    
                    await imprimirCodigoBarras(productoId, cantidad);
                    exitosos++;
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            } catch (error) {
                console.error(`Error imprimiendo producto ${i + 1}:`, error);
                errores++;
            }
        }
    }
    
    if (errores === 0) {
        mostrarNotificacion(`‚úÖ ${exitosos} productos enviados a imprimir correctamente`, 'success');
    } else {
        mostrarNotificacion(`‚ö†Ô∏è ${exitosos} √©xito, ${errores} errores`, 'error');
    }
}

// ========================================
// NOTIFICACIONES
// ========================================
function mostrarNotificacion(mensaje, tipo = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${tipo}`;
    notification.innerHTML = `
        <div class="notification-icon">${tipo === 'success' ? '‚úÖ' : '‚ö†Ô∏è'}</div>
        <div class="notification-content">
            <strong>${tipo === 'success' ? '√âxito' : 'Error'}</strong>
            <p style="margin: 0; color: #64748b;">${mensaje}</p>
        </div>
    `;
    
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// ========================================
// UTILIDADES
// ========================================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}